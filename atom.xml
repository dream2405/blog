<?xml version="1.0" encoding="utf-8"?><?xml-stylesheet type="text/xsl" href="atom.xsl"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://dream2405.github.io/blog/</id>
    <title>낙서장 Blog</title>
    <updated>2025-09-03T00:00:00.000Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://dream2405.github.io/blog/"/>
    <subtitle>낙서장 Blog</subtitle>
    <icon>https://dream2405.github.io/blog/img/favicon.ico</icon>
    <entry>
        <title type="html"><![CDATA[An Introduction to wait-free algorithms]]></title>
        <id>https://dream2405.github.io/blog/intro-wait-free-algorithms/</id>
        <link href="https://dream2405.github.io/blog/intro-wait-free-algorithms/"/>
        <updated>2025-09-03T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[image.png]]></summary>
        <content type="html"><![CDATA[<p><img decoding="async" loading="lazy" alt="image.png" src="https://dream2405.github.io/blog/assets/images/image-793184ce99f39c598355fd33aeba250e.png" width="1627" height="915" class="img_ev3q"></p>
<p><a href="https://youtu.be/kPh8pod0-gk?si=fnCqMylNxru464Ot" target="_blank" rel="noopener noreferrer">유튜브 링크</a></p>
<p>이 글은 CppCon 2024에서 카네기 멜런 대학교의 조교수(assistant teaching professor),
Daniel Anderson이 발표한 자료를 바탕으로 작성되었다.</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="배울-내용">배울 내용<a href="https://dream2405.github.io/blog/intro-wait-free-algorithms/#%EB%B0%B0%EC%9A%B8-%EB%82%B4%EC%9A%A9" class="hash-link" aria-label="배울 내용에 대한 직접 링크" title="배울 내용에 대한 직접 링크">​</a></h2>
<ul>
<li>동시성과 lock-free 프로그래밍에 대한 간단한 복습</li>
<li>lock-free 설계 패턴의 "기본적인" 내용 검토</li>
<li>wait-free 알고리즘의 정의와 실제 적용에 대한 이해</li>
<li>우아한 wait-free 알고리즘과 wait-free 설계의 예시</li>
<li>간단한 벤치마크 결과</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="해결하고자-하는-문제">해결하고자 하는 문제<a href="https://dream2405.github.io/blog/intro-wait-free-algorithms/#%ED%95%B4%EA%B2%B0%ED%95%98%EA%B3%A0%EC%9E%90-%ED%95%98%EB%8A%94-%EB%AC%B8%EC%A0%9C" class="hash-link" aria-label="해결하고자 하는 문제에 대한 직접 링크" title="해결하고자 하는 문제에 대한 직접 링크">​</a></h3>
<p>sticky counter (0에서 멈추는 카운터)를 구현하고 싶다고 가정하자.</p>
<p><code>Counter</code> 구조체의 기본적인 인터페이스는 다음과 같다.</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Precondition: The counter is not zero</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">Counter</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// If the counter is greater than zero, add one and return true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// otherwise do nothing and return false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">bool</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">increment_if_not_zero</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Decrement the counter. If the counter now equals zero,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// return true. Otherwise return false.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">bool</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">decrement</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint64_t</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">read</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Return the current value of the counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p><code>Counter</code> 구조체는 다음과 같은 세 가지 주요 기능을 제공한다.</p>
<ul>
<li><code>increment_if_not_zero()</code> : 카운터 증가를 시도<!-- -->
<ul>
<li>카운터가 <code>0</code>보다 크면 <code>1</code>을 더하고 <code>true</code> 반환</li>
<li>카운터가 <code>0</code>이면 아무것도 하지 않고 <code>false</code> 반환</li>
</ul>
</li>
<li><code>decrement()</code> : 카운터를 감소<!-- -->
<ul>
<li>카운터를 감소시킨 후  <code>0</code>이 되면 <code>true</code> 반환</li>
<li>카운터를 감소시킨 후  <code>0</code>이 아니라면 <code>false</code> 반환</li>
</ul>
</li>
<li><code>read()</code> : 현재 카운터 값을 반환</li>
</ul>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>노트</div><div class="admonitionContent_BuS1"><p>이런 방식의 카운터는 매우 실용적이다.
동시성 자료구조나, 멀티스레딩 환경에서의 메모리 관리에 매우 적합하다.</p><p>예로 들어 <code>std::weak_ptr&lt;T&gt;::lock</code>에 이런 방식의 카운터가 필요하다.</p><p><code>std::weak_ptr&lt;T&gt;::lock</code> 의 주요 기능은 다음과 같다.</p><ul>
<li><code>weak_ptr</code>가 가리키는 객체가 아직 유효한지 확인</li>
<li>유효하다면 해당 객체에 대한 <code>shared_ptr</code>를 반환</li>
<li>객체가 이미 삭제되었다면 빈 <code>shared_ptr</code> (<code>nullptr</code>을 가리킴)을 반환</li>
</ul><p>따라서 <code>weak_ptr</code>은 다음과 같이 동작해야 한다.</p><ul>
<li>객체의 수명을 추적하되 reference count는 증가되지 않음</li>
<li><code>lock()</code> 호출 시 객체가 아직 존재하는지 확인해야 함</li>
<li>확인하는 동안 다른 스레드에서 객체를 삭제할 수 있음</li>
</ul><p>여기서 <code>Counter</code> 의 역할은 다음과 같다.</p><ul>
<li>객체가 아직 살아있는지(reference count &gt; 0) 확인</li>
<li>살아있다면 reference count를 증가시켜 객체 수명 연장</li>
<li>이 두 작업이 atomic하게 이뤄져야 함</li>
</ul></div></div>
<p>이제 인터페이스를 구현해보자.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="첫-번째-구현">첫 번째 구현<a href="https://dream2405.github.io/blog/intro-wait-free-algorithms/#%EC%B2%AB-%EB%B2%88%EC%A7%B8-%EA%B5%AC%ED%98%84" class="hash-link" aria-label="첫 번째 구현에 대한 직접 링크" title="첫 번째 구현에 대한 직접 링크">​</a></h2>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">Counter</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">bool</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">increment_if_not_zero</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">counter </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            counter</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">bool</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">decrement</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">counter </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint64_t</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">read</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> counter</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint64_t</span><span class="token plain"> counter</span><span class="token punctuation" style="color:#393A34">{</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>동시성 환경을 고려하지 않은 단순한 구현이다. 이런 방식의 구현은 싱글 스레드 환경에서는 문제가 없지만, 멀티 스레드 환경에서는 문제가 생길 것임을 알아차릴 수 있을 것이다.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="thread-safe-하게-만들기">Thread safe 하게 만들기<a href="https://dream2405.github.io/blog/intro-wait-free-algorithms/#thread-safe-%ED%95%98%EA%B2%8C-%EB%A7%8C%EB%93%A4%EA%B8%B0" class="hash-link" aria-label="Thread safe 하게 만들기에 대한 직접 링크" title="Thread safe 하게 만들기에 대한 직접 링크">​</a></h3>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">Counter</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">bool</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">increment_if_not_zero</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">lock_guard g_</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">m</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">counter </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            counter</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">bool</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">decrement</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">lock_guard g_</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">m</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">counter </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">mutex m</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint64_t</span><span class="token plain"> counter</span><span class="token punctuation" style="color:#393A34">{</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>두 함수를 스레드-안전하게 만들었다.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>정보</div><div class="admonitionContent_BuS1"><p><code>std::lock_guard</code>는 C++의 RAII(Resource Acquisition Is Initialization) 패턴을 활용한 mutex wrapper 클래스이다.</p><p>이를 통해 뮤텍스를 lock하면, 명시적인 unlock 대신 스코프를 벗어나면 자동으로 소멸되게 만들어 mutex도 자동으로 해제된다.</p></div></div>
<p>이를 통해 무엇을 알 수 있는가?</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="시사점">시사점<a href="https://dream2405.github.io/blog/intro-wait-free-algorithms/#%EC%8B%9C%EC%82%AC%EC%A0%90" class="hash-link" aria-label="시사점에 대한 직접 링크" title="시사점에 대한 직접 링크">​</a></h2>
<ul>
<li>이런 방식은 동시성 문제의 대부분을 해결할 수 있다</li>
<li>하지만 이는 실질적으로 <strong>동시성을 제거</strong>함으로써 해결하는 것.</li>
<li>이런 방식은 대체로(항상은 아님) 성능에 큰 영향을 미친다<!-- -->
<ul>
<li>주의사항: 성능에 대해 <strong>추측하지 마라</strong>. 항상 <strong>성능을 측정</strong>해야 한다.</li>
</ul>
</li>
</ul>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>노트</div><div class="admonitionContent_BuS1"><p>실질적으로 동시성을 제거함으로써 해결하는 것이라는 비판은 critical section에 대해 얘기하는 것 같다.</p><p>코드의 일부분에 대해 <strong>동시성 상황을 차단</strong>해버림으로써, 동시성 상황이 애초부터 일어나지 않으므로 당연히 동시성 문제는 발생하지 않는다.</p><p>이는 어떻게 보면 매우 단순한 해결 방법이라고 할 수 있다. 문제를 해결하는 것이 아니라 <strong>문제가 발생할 것 같은 상황</strong>을 차단해버리는 것이기 때문이다.</p></div></div>
<p>그렇다면 더 발전된 방식은 어떤것들이 있는가?</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="진행-보장progress-guarantees">진행 보장(Progress guarantees)<a href="https://dream2405.github.io/blog/intro-wait-free-algorithms/#%EC%A7%84%ED%96%89-%EB%B3%B4%EC%9E%A5progress-guarantees" class="hash-link" aria-label="진행 보장(Progress guarantees)에 대한 직접 링크" title="진행 보장(Progress guarantees)에 대한 직접 링크">​</a></h2>
<p>진행 보장이란 동시성 알고리즘을 이론적으로 분류하는 방법이다.</p>
<ul>
<li><strong>Blocking</strong>: 보장 없음<!-- -->
<ul>
<li>앞서 본 뮤텍스를 사용한 방식이 한 예시</li>
<li>다른 스레드가 mutex를 보유하고 있으면, 현재 스레드는 무조건 대기해야 한다</li>
<li>다른 모든 스레드가 중단되더라도(isolation 상태), mutex를 보유한 스레드가 살아있지 않다면 영원히 진행하지 못할 수 있음 - deadlock 발생 가능성</li>
</ul>
</li>
<li><strong>Obstruction free</strong> (isolation에서의 진행): 하나의 스레드가 격리된 상태에서 실행되면 유한한 수의 단계 내에 연산을 완료<!-- -->
<ul>
<li>어떠한 스레드든지 간에, 하나의 스레드 외에 다른 모든 스레드가 중단된 상태라면 어떠한 상황이든지 간에 반드시 유한한 단계 내에 작업을 완료할 수 있어야 한다.</li>
<li>따라서 이 방식은 deadlock에 면역</li>
</ul>
</li>
<li><strong>Lock free</strong> (최소 하나의 스레드가 진행): 어느 시점에서든 최소한 하나의 스레드는 자신의 연산에서 진행을 이루고 있음<!-- -->
<ul>
<li>시스템 전체의 처리량을 보장. 일부 연산은 항상 완료되고 있지만, 개별 연산의 완료는 절대 보장되지 않음</li>
</ul>
</li>
<li><strong>Wait free</strong> (모든 스레드가 진행): 다른 동시 연산에 관계없이 모든 연산이 유한한 수의 단계 내에 완료됨<!-- -->
<ul>
<li>모든 개별 연산에 대해 유한한 완료 시간을 보장함</li>
</ul>
</li>
</ul>
<p>이제 <code>Counter</code> 를 lock-free로 구현해보자.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="lock-free-구현">lock-free 구현<a href="https://dream2405.github.io/blog/intro-wait-free-algorithms/#lock-free-%EA%B5%AC%ED%98%84" class="hash-link" aria-label="lock-free 구현에 대한 직접 링크" title="lock-free 구현에 대한 직접 링크">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="counter-변수"><code>counter</code> 변수<a href="https://dream2405.github.io/blog/intro-wait-free-algorithms/#counter-%EB%B3%80%EC%88%98" class="hash-link" aria-label="counter-변수에 대한 직접 링크" title="counter-변수에 대한 직접 링크">​</a></h3>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">atomic</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">uint64_t</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> counter</span><span class="token punctuation" style="color:#393A34">{</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>lock-free 프로그래밍을 할려면, atomic 변수를 사용해야 한다.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="increment_if_not_zero-를-구현"><code>increment_if_not_zero()</code> 를 구현<a href="https://dream2405.github.io/blog/intro-wait-free-algorithms/#increment_if_not_zero-%EB%A5%BC-%EA%B5%AC%ED%98%84" class="hash-link" aria-label="increment_if_not_zero-를-구현에 대한 직접 링크" title="increment_if_not_zero-를-구현에 대한 직접 링크">​</a></h3>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">bool</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">increment_if_not_zero</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> current </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> counter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">load</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">current </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">counter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">compare_exchange_weak</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">current</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> current </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> current </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>여기서 <code>compare_exchange_weak()</code> 라는 연산이 등장한다.</p>
<p><code>counter.compare_exchange_weak(current, current + 1)</code> 코드의 의미는 다음과 같다.</p>
<ul>
<li><code>counter</code>의 현재 값이 <code>current</code>와 같다면<!-- -->
<ul>
<li><code>counter</code> 값을 <code>current + 1</code>로 변경</li>
<li><code>true</code> 반환</li>
</ul>
</li>
<li>다르다면<!-- -->
<ul>
<li><code>current</code>를 <code>counter</code>의 현재 값으로 업데이트</li>
<li><code>false</code> 반환</li>
</ul>
</li>
</ul>
<p><code>compare_exchange_weak()</code> 연산은 다음과 같이 이루어진다.</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">compare_exchange</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">expected</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> desired</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">current_value </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> expected</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        current_value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> desired</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        expected </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> current_value</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>경고</div><div class="admonitionContent_BuS1"><p>실제 <code>compare_exchange</code> 연산의 구현은 <strong>하드웨어의 지원 없이는 불가능</strong>하다.
코드로 구현하려면 결국 어떠한 형태로든 lock이 필요하기 때문에 atomic함을 보장할 수 없다.</p><p>실제로는 ARM, x86_64 등의 아키텍처에서 atomic 연산을 위한 명령어를 제공하므로 이를 통해 구현한다.</p></div></div>
<p>이런 방식을 <strong>CAS loop</strong>라고 한다.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="decrement-구현"><code>decrement()</code> 구현<a href="https://dream2405.github.io/blog/intro-wait-free-algorithms/#decrement-%EA%B5%AC%ED%98%84" class="hash-link" aria-label="decrement-구현에 대한 직접 링크" title="decrement-구현에 대한 직접 링크">​</a></h3>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">bool</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">decrement</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> counter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">fetch_sub</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p><code>counter.fetch_sub(1)</code> 코드의 의미는 다음과 같다.</p>
<ul>
<li><code>counter</code>를 <code>1</code> 감소시키고 원래의 <code>counter</code> 값 반환</li>
</ul>
<p>따라서 반환값이  <code>1</code>이었다면 감소 후 <code>0</code>이 되었다는 의미이므로 <code>true</code> 를 반환한다.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="전체-코드">전체 코드<a href="https://dream2405.github.io/blog/intro-wait-free-algorithms/#%EC%A0%84%EC%B2%B4-%EC%BD%94%EB%93%9C" class="hash-link" aria-label="전체 코드에 대한 직접 링크" title="전체 코드에 대한 직접 링크">​</a></h3>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">Counter</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">bool</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">increment_if_not_zero</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> current </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> counter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">load</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">current </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">counter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">compare_exchange_weak</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">current</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> current </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> current </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">bool</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">decrement</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> counter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">fetch_sub</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint64_t</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">read</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> counter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">load</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">atomic</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">uint64_t</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> counter</span><span class="token punctuation" style="color:#393A34">{</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="cas-loop"><strong>CAS loop</strong><a href="https://dream2405.github.io/blog/intro-wait-free-algorithms/#cas-loop" class="hash-link" aria-label="cas-loop에 대한 직접 링크" title="cas-loop에 대한 직접 링크">​</a></h2>
<p>이런 CAS loop(compare-and-swap loop) 방식은 lock-free 알고리즘과 데이터 구조의 기본이 되는 설계 패턴이다.</p>
<ul>
<li>데이터 구조의 현재 상태를 읽음</li>
<li>현재 상태로부터 새로운 원하는 상태를 계산</li>
<li>다른 누군가가 이미 변경하지 않았을 때만 변경을 커밋(compare-exchange)</li>
<li>다른 누군가가 변경했다면, 다시 시도</li>
</ul>
<p>진행은 <strong>lock-free</strong>이다.</p>
<ul>
<li>만약 한 연산이 진행하지 못했다면(compare-exchange가 false를 반환)
이는 다른 연산이 진행했기 때문</li>
<li>스레드별 개별 연산은 실패하더라도, <strong>시스템 전체적으로 진행</strong>은 보장</li>
</ul>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>노트</div><div class="admonitionContent_BuS1"><p>CAS loop 방식이 기존의 blocking 방식과 다른 핵심적인 이유는 결국 <strong>진행 가능 여부를 판단하는 상태</strong>에 있다.</p><p>CAS loop는 <code>counter</code> <strong>값 자체</strong>가 진행 가능 여부를 결정한다.</p><ul>
<li>실제 작업 대상(<code>counter</code>)과 진행 가능 여부 판단이 결합되어 있음</li>
<li><code>counter</code> 값이 변경되었다는 것 → 다른 스레드가 진행했다는 것</li>
</ul><p>Mutex는 mutex라는 <strong>별도의 상태값</strong>으로 진행 가능 여부를 결정</p><ul>
<li>실제 작업 대상(<code>counter</code>)과 진행 가능 여부 판단이 분리되어 있음</li>
<li><code>mutex</code> 획득 실패 → 진행 불가, 하지만 이것이 다른 스레드의 진행을 보장하지는 않음</li>
</ul><p>이 차이로 인해</p><ul>
<li>CAS loop는 진행 실패가 곧 다른 스레드의 진행을 의미</li>
<li>Mutex는 진행 실패가 다른 스레드의 진행을 보장하지 않음</li>
</ul><p>따라서 lock-free의 시스템 전체적 진행 보장은 상태값과 작업이 결합되어 있다는 특성에서 자연스럽게 도출되는 것이다.</p></div></div>
<p><strong>wait-free는 아니다.</strong></p>
<ul>
<li>특정 연산이 경쟁하는 연산들이 성공하면서 CAS loop에서 영원히 실패할 수 있기 때문</li>
<li>극단적인 예시로는, 멀티 스레드 환경에서 하나의 스레드만이 진행하고 다른 모든 스레드들이 계속 실패할 수도 있다.</li>
</ul>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>정보</div><div class="admonitionContent_BuS1"><p>좀 더 전문적인 용어로는, lock-free 방식은 blocking 방식과는 달리 deadlock 현상을 방지하지만, 개별 스레드가 영원히 진행하지 못하는 <strong>starvation</strong> 현상은 막지 못한다고 설명할 수 있다.</p><p>그리고 이 starvation 현상까지도 막는 것이 wait-free 방식의 목표 중 하나이다.</p></div></div>
<p>그렇다면 wait-free는 어떻게 설계해야 하는가?</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="wait-freedom-도구들">Wait Freedom 도구들<a href="https://dream2405.github.io/blog/intro-wait-free-algorithms/#wait-freedom-%EB%8F%84%EA%B5%AC%EB%93%A4" class="hash-link" aria-label="Wait Freedom 도구들에 대한 직접 링크" title="Wait Freedom 도구들에 대한 직접 링크">​</a></h2>
<p>wait-free 알고리즘은 무한한 CAS 루프를 포함할 수 없다.</p>
<ul>
<li>이는 compare-exchange를 사용할 수 없다는 의미가 아니라, 단지 무한 루프 안에서 사용할 수 없다는 의미!</li>
</ul>
<p>대부분의 wait-free 알고리즘은 atomic read-modify-write 연산을 사용한다.</p>
<ul>
<li>compare_exchange_weak/strong(expected, desired)<!-- -->
<ul>
<li>Atomically replaces the current value with desired if current equals expected, otherwise loads the current value</li>
</ul>
</li>
<li>fetch_add(x) / fetch_sub(x)<!-- -->
<ul>
<li>Atomically add/subtract x from the given variable and return the original value</li>
</ul>
</li>
<li>exchange(desired)<!-- -->
<ul>
<li>Stores the value desired and returns the old value</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="wait-free-알고리즘을-향하여">Wait-free 알고리즘을 향하여<a href="https://dream2405.github.io/blog/intro-wait-free-algorithms/#wait-free-%EC%95%8C%EA%B3%A0%EB%A6%AC%EC%A6%98%EC%9D%84-%ED%96%A5%ED%95%98%EC%97%AC" class="hash-link" aria-label="Wait-free 알고리즘을 향하여에 대한 직접 링크" title="Wait-free 알고리즘을 향하여에 대한 직접 링크">​</a></h2>
<p>기존의 lock-free 알고리즘의 핵심은 CAS loop</p>
<ul>
<li>스레드들이 다른 스레드들의 진행을 <strong>방해</strong>함</li>
<li>즉 스레드들이 다른 스레드들을 <strong>희생</strong>시키면서 자신의 연산을 먼저 완료하려고 경쟁!</li>
<li>wait freedom을 달성하기 위해서는, 스레드들이 경쟁하는 스레드들에 의해 <strong>차단되어서는 안 됨</strong></li>
</ul>
<p>wait-free 알고리즘의 설계</p>
<ul>
<li>경쟁적이기보다는 <strong>협력적</strong>이어야 함</li>
<li>Wait-free 알고리즘 설계의 핵심은 <strong>helping</strong></li>
<li>진행 중인 다른 연산과 동시에 실행되는 연산들은 그들을 기다리거나 그들과 경쟁하는 대신 그들의 진행을 돕기 위해 시도</li>
<li>진행 중인 다른 연산들을 감지할 수 있는 방법이 필요</li>
</ul>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>노트</div><div class="admonitionContent_BuS1"><p>발표자 Daniel Anderson 교수에 따르면, 이는 쉽지 않은 방법이다.
어떠한 CAS loop 방식이건 간에 helping 방식으로 바꾸는게 가능한것도 아니다.</p><p>바꾸는게 가능하더라도, blocking 방식을 lock-free로 바꾸는 것보다,
일반적으로 훨씬 큰 알고리즘의 재설계가 필요하다.</p><p>그럼에도 불구하고 wait-free 알고리즘의 장점이 뚜렷하기 때문에 우리는 알아야 한다.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="wait-free-counter-design">Wait-free counter design<a href="https://dream2405.github.io/blog/intro-wait-free-algorithms/#wait-free-counter-design" class="hash-link" aria-label="Wait-free counter design에 대한 직접 링크" title="Wait-free counter design에 대한 직접 링크">​</a></h2>
<p>wait-free 방식 counter를 만들기 위해 요구되는 것은 2가지이다.</p>
<ul>
<li>연산들이 다른 연산들이 진행 중인지 감지할 방법이 필요</li>
<li>다른 스레드들에게 우리가 counter를 0으로 설정할 계획이 있거나 이미 설정했다는 것을 알릴 방법이 필요<!-- -->
<ul>
<li>스레드들끼리 <strong>협력</strong>하기 위해서 이런 정보를 알아야 한다. 이것이 이전의 방식과의 핵심 차별점이다.</li>
</ul>
</li>
</ul>
<p><strong>핵심 아이디어</strong>: counter의 상위 비트들 중 일부를 플래그로 사용한다.</p>
<p><img decoding="async" loading="lazy" alt="image.png" src="https://dream2405.github.io/blog/assets/images/image%201-252b3796fbbeb2952c66108e9d26a2a8.png" width="1273" height="296" class="img_ev3q"></p>
<ul>
<li>최상위 플래그는, 어떠한 스레드가 counter가 0으로 설정되었다는 것을 <strong>알리기 위해</strong> 사용</li>
<li>두 번째 플래그는 <strong>helping</strong>을 위해 사용</li>
</ul>
<p>우선 읽기가 없는 카운터를 만들어보자.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="wait-free-counter-without-read">Wait-free counter without read<a href="https://dream2405.github.io/blog/intro-wait-free-algorithms/#wait-free-counter-without-read" class="hash-link" aria-label="Wait-free counter without read에 대한 직접 링크" title="Wait-free counter without read에 대한 직접 링크">​</a></h3>
<p>우선 <code>is_zero</code> flag를 설정하자.</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">constexpr</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">uint64_t</span><span class="token plain"> is_zero </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1ull</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">63</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>그리고 <code>decrement()</code> 연산을 정의한다.</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">bool</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">decrement</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">counter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">fetch_sub</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">uint64_t</span><span class="token plain"> e </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> counter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">compare_exchange_strong</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> is_zero</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>동작 방식은 다음과 같다.</p>
<ol>
<li><code>counter</code>를 <code>1</code> 감소시키고 이전 값을 반환(<code>fetch_sub()</code>)</li>
<li>만약 이전 값이 <code>1</code>이었다면:<!-- -->
<ul>
<li><code>counter</code>가 <code>0</code>이 되었을 것이므로</li>
<li><code>counter</code>가 아직 <code>0</code>인지 확인하고(e = 0)</li>
<li>맞다면 <code>is_zero</code> flag를 설정</li>
</ul>
</li>
<li>그 외의 경우 <code>false</code> 반환</li>
</ol>
<p><code>0</code>이 되는 순간을 정확히 감지하고 flag를 설정하는 것이 핵심이다.</p>
<p>마지막으로 CAS loop 없이 어떻게 increment를 하는지 flag의 마법을 보자.</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">bool</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">increment_if_not_zero</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">counter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">fetch_add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> is_zero</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>동작 방식은 다음과 같다.</p>
<ol>
<li><code>counter</code>를 <code>1</code> 증가시키고 이전 값을 반환(<code>fetch_add()</code>)</li>
<li>이전 값의 최상위 비트(<code>is_zero</code> flag)를 확인</li>
<li>flag가 <code>0</code>이면 <code>true</code> 반환 (<code>counter</code>가 <code>0</code>이 아니었음을 의미)</li>
<li>flag가 <code>1</code>이면 <code>false</code> 반환 (이미 <code>counter</code>가 <code>0</code>이었음을 의미)</li>
</ol>
<p>최상위 비트가 <code>1</code> 이면, 카운터는 <code>0</code> 이고 하위 비트들은 보지 않는 것이 핵심이다.</p>
<p><img decoding="async" loading="lazy" alt="image.png" src="https://dream2405.github.io/blog/assets/images/image%202-dc2ba5fc4527c04c61c263a272b4331b.png" width="977" height="633" class="img_ev3q"></p>
<p>다음과 같이 하위 비트가 계속 증가하더라도, 최상위 비트가 <code>1</code>이므로 카운터는 하위 비트와 상관없이 <code>0</code>이다.</p>
<p>전체 코드는 다음과 같다.</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">Counter</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">constexpr</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">uint64_t</span><span class="token plain"> is_zero </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1ull</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">63</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">bool</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">increment_if_not_zero</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">counter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">fetch_add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> is_zero</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">bool</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">decrement</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">counter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">fetch_sub</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">uint64_t</span><span class="token plain"> e </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> counter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">compare_exchange_strong</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> is_zero</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">atomic</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">uint64_t</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> counter</span><span class="token punctuation" style="color:#393A34">{</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>여기까지만 보면 꽤 좋은 아이디어 같아 보인다. 그러나 이 구현은 <strong>문제점이 있다</strong>.</p>
<p><code>decrement()</code> 구현의 일부분을 보자.</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">counter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">fetch_sub</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// counter가 1에서 0으로 변함</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint64_t</span><span class="token plain"> e </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> counter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">compare_exchange_strong</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> is_zero</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 이 compare_exchange가 실패하면??</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>이 부분에서,</p>
<ol>
<li><code>decrement()</code> 연산이 실제로 <code>counter</code>를 0으로 만듦</li>
<li><code>increment()</code>가 그 사이에 발생</li>
<li><code>decrement()</code>연산이 마치 <code>increment()</code> 이후에 발생한 것처럼 처리</li>
</ol>
<p>그러나 이 특징은 <strong>read가 없다면</strong> 문제가 되지 않는다.</p>
<p><code>decrement()</code> 목적은 결국</p>
<ul>
<li><code>counter</code>가 <code>0</code>이 되는 순간을 포착</li>
<li>그 순간을 다른 스레드들에게 영구적으로 알리는 것</li>
</ul>
<p>인데, 만약 CAS가 실패한다면</p>
<ul>
<li>다른 스레드가 이미 <code>counter</code>를 증가시켰다는 의미</li>
<li>즉 우리가 관찰한 "0이 되는 순간"은 실제로 의미있는 순간이 아니었음</li>
<li><code>counter</code>는 진짜로 "멈춘" 적이 없었던 것</li>
</ul>
<p>따라서 이는 우리가 구현한 카운터의 의미와 부합한다.</p>
<p>그렇다면 read가 있다면 어떤 문제가 발생하는가?</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="adding-a-read-operation-how-hard-can-it-be">Adding a read operation. How hard can it be?<a href="https://dream2405.github.io/blog/intro-wait-free-algorithms/#adding-a-read-operation-how-hard-can-it-be" class="hash-link" aria-label="Adding a read operation. How hard can it be?에 대한 직접 링크" title="Adding a read operation. How hard can it be?에 대한 직접 링크">​</a></h3>
<p><code>read()</code> 를 추가한다.</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">uint64_t</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">read</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> val </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> counter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">load</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">val </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> is_zero</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> val</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p><code>val</code> 을 불러오고, <code>is_zero</code> flag가 켜져있으면 <code>0</code>, 아니면 <code>val</code>을 반환한다.</p>
<p>다음과 같은 시나리오를 생각해보자.</p>
<ol>
<li><code>read()</code>는 <code>counter</code>가 <code>0</code>이라고 판단했지만</li>
<li>실제로는 <code>decrement()</code>가 <code>false</code>를 반환(CAS 실패)</li>
<li><code>increment()</code>는 성공</li>
<li>결과적으로 <code>counter</code>는 <code>1</code>이어야 하는데 <code>read()</code>는 <code>0</code>을 반환</li>
</ol>
<p>즉 <code>read()</code> 연산이 <strong>관찰한 상태와 실제 연산의 결과가 불일치</strong>하는 문제가 발생한다.</p>
<p>따라서 <strong><code>val</code> 이 <code>0</code> 일 때</strong> 문제가 발생할 수 있다. 코드를 수정해야 한다.</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">uint64_t</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">read</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> val </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> counter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">load</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">val </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> then what</span><span class="token operator" style="color:#393A34">?</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>이때 해야 하는 게 <strong>helping</strong>이다!</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">uint64_t</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">read</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> val </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> counter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">load</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">val </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> counter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">compare_exchange_strong</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">val</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> is_zero</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// helping!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">val </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> is_zero</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> val</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>다음과 같이 읽어들인 값이 <code>0</code>이라면, <code>is_zero</code> flag 설정을 <code>read()</code> 가 <strong>도와준다</strong>.</p>
<p>그러나 이 방법은 다음과 같은 <strong>문제점을 초래</strong>한다.</p>
<ul>
<li><code>read()</code>가 <code>is_zero</code> flag를 설정하면, 어떤 <code>decrement()</code>도 <code>true</code>를 반환하지 않음!</li>
</ul>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>노트</div><div class="admonitionContent_BuS1"><p>만약 레퍼런스 카운터로 이런 방식을 취한다면, 다음과 같은 문제점을 발생시킨다.
레퍼런스 카운터는 <strong>참조 카운트가 0이 되면 반드시 객체가 삭제</strong>돼야 한다.</p><p>그러나 이런 방식을 사용하면, <code>true</code>를 반환한 <code>decrement()</code> 가 없는데도 카운트가 <code>0</code> 이 되었으므로, 누구도 삭제 책임을 지지 않아 <strong>메모리가 누수</strong>될 수 있다.</p></div></div>
<p>이런 문제의 해결을 위해서, 추가적인 flag가 필요하다.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="almost-there">Almost there<a href="https://dream2405.github.io/blog/intro-wait-free-algorithms/#almost-there" class="hash-link" aria-label="Almost there에 대한 직접 링크" title="Almost there에 대한 직접 링크">​</a></h3>
<p>다음과 같은 helped flag를 추가한다.</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> constexpt </span><span class="token keyword" style="color:#00009f">uint64_t</span><span class="token plain"> helped </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1ull</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">62</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p><code>read()</code>가 <code>is_zero</code> flag를 설정할 때, 이 <code>helped</code> flag를 설정한다.</p>
<p>그리고 <code>decrement()</code> 를 수정한다.</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">bool</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">decrement</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">counter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">fetch_sub</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">uint64_t</span><span class="token plain"> e </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">counter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">compare_exchange_strong</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> is_zero</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> helped</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">counter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">exchange</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">is_zero</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> helped</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>핵심적인 부분은 <code>e &amp; helped) &amp;&amp; (counter.exchange(is_zero) &amp; helped</code> 이 부분이다.</p>
<ol>
<li><code>(e &amp; helped)</code>
<ul>
<li><code>helped</code> flag가 설정되어 있는지 확인</li>
<li>즉, <code>read()</code> 연산이 도와주었는지 확인</li>
</ul>
</li>
<li><code>exchange(is_zero)</code>
<ul>
<li>현재 값을 is_zero로 교체하고 이전 값을 반환</li>
<li><code>helped</code> flag는 제거됨 (<code>is_zero</code>만 설정)</li>
</ul>
</li>
<li><code>(exchange(is_zero) &amp; helped)</code>
<ul>
<li><code>exchange</code>가 반환한 이전 값에 helped flag가 있는지 확인</li>
<li><code>exchange</code>는 atomic하므로 정확히 하나의 <code>decrement</code>만 <code>helped</code> flag를 볼 수 있음</li>
<li>다른 <code>decrement</code>들은 이미 <code>helped</code> flag가 제거된 값을 보게 됨</li>
</ul>
</li>
</ol>
<p>따라서 이 코드는,</p>
<ul>
<li><code>read</code>가 도와주었는지 확인하고</li>
<li>atomic하게 <code>helped</code> flag를 제거하면서</li>
<li>정확히 하나의 <code>decrement</code>만 true를 반환하도록 보장</li>
</ul>
<p>마지막으로 <code>read()</code> 를 수정한다.</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">uint64_t</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">read</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> val </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> counter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">load</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">val </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> counter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">compare_exchange_strong</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">val</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> is_zero </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> helped</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// helping!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">val </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> is_zero</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> val</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>기존의 코드에, <code>counter</code>를 <code>is_zero</code> flag를 설정하는데 <strong>도와주었다면</strong> <code>helped</code> flag도 추가적으로 설정하는 부분을 추가했다.</p>
<p>전체 코드는 다음과 같다.</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">Counter</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">constexpr</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">uint64_t</span><span class="token plain"> is_zero </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1ull</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">63</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> constexpt </span><span class="token keyword" style="color:#00009f">uint64_t</span><span class="token plain"> helped </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1ull</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">62</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">bool</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">increment_if_not_zero</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">counter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">fetch_add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> is_zero</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">bool</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">decrement</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">counter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">fetch_sub</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">uint64_t</span><span class="token plain"> e </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">counter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">compare_exchange_strong</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> is_zero</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> helped</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">counter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">exchange</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">is_zero</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> helped</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint64_t</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">read</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> val </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> counter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">load</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">val </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> counter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">compare_exchange_strong</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">val</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> is_zero </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> helped</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// helping!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">val </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> is_zero</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> val</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">atomic</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">uint64_t</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> counter</span><span class="token punctuation" style="color:#393A34">{</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>wait-free 알고리즘을 완성했다. 기존의 방법과 나아졌을까?</p>
<p>앞서 말했듯이, 성능에 대해 추측하지 말고, 성능을 측정해야 한다.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="벤치마크">벤치마크<a href="https://dream2405.github.io/blog/intro-wait-free-algorithms/#%EB%B2%A4%EC%B9%98%EB%A7%88%ED%81%AC" class="hash-link" aria-label="벤치마크에 대한 직접 링크" title="벤치마크에 대한 직접 링크">​</a></h2>
<p>Daniel Anderson 교수가  <code>atomic&lt;shared_ptr&gt;</code> 구현에서 wait-free counter와 lock-free counter를 비교했다.</p>
<p>결과는 다음과 같다.</p>
<p><strong>p개의 스레드가 <code>atomic&lt;shared_ptr&gt;</code>에서 load하는 경우</strong></p>
<p><img decoding="async" loading="lazy" alt="image.png" src="https://dream2405.github.io/blog/assets/images/image%203-e709ab9d57ee346e2d422008d797facd.png" width="1960" height="479" class="img_ev3q"></p>
<p><strong>p개의 스레드, 50%는 load, 나머지 50%는 store</strong></p>
<p><img decoding="async" loading="lazy" alt="image.png" src="https://dream2405.github.io/blog/assets/images/image%204-9d0f3d00dd67a606b6184302294cbd67.png" width="1982" height="506" class="img_ev3q"></p>
<p><strong>p개의 스레드, 10%는 load, 나머지 90%는 store</strong></p>
<p><img decoding="async" loading="lazy" alt="image.png" src="https://dream2405.github.io/blog/assets/images/image%205-6ca08057026f85900618699544792f60.png" width="1972" height="419" class="img_ev3q"></p>
<p>비록 간단한 벤치마크이지만, 다음과 같은 결론을 얻을 수 있다.</p>
<ul>
<li>어떤 알고리즘이 최선인지는 종종 워크로드에 달려있음</li>
<li>얼마나 많은 read vs write가 있는지</li>
<li>얼마나 많은 스레드/코어가 있는지</li>
<li>Wait-free는 read-mostly 워크로드에서 더 나았지만, lock-free는 write-mostly에서 더 나아 보임</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="핵심-메시지">핵심 메시지<a href="https://dream2405.github.io/blog/intro-wait-free-algorithms/#%ED%95%B5%EC%8B%AC-%EB%A9%94%EC%8B%9C%EC%A7%80" class="hash-link" aria-label="핵심 메시지에 대한 직접 링크" title="핵심 메시지에 대한 직접 링크">​</a></h2>
<p>성능 관련</p>
<ul>
<li>절대 성능에 대해 추측하지 말 것</li>
<li>하지만 알고리즘의 progress guarantees를 분석하여 성능을 가설화하고, 이러한 progress guarantees를 알고리즘 설계의 지침으로 사용할 것</li>
<li>그리고 나서 벤치마크를 수행할 것</li>
</ul>
<p>Progress guarantees (진행 보장)</p>
<ul>
<li>동시성 알고리즘을 분류하는 유용한 이론적 기준이며 알고리즘 설계에 도움을 줄 수 있음</li>
<li>Lock-free 알고리즘은 한 스레드가 진행함을 보장하는 반면, Wait-free 알고리즘은 모든 스레드의 진행을 보장함</li>
</ul>
<p>Wait-free 알고리즘 설계</p>
<ul>
<li>핵심 기법은 helping - 연산들이 서로 대기하거나(blocking) 경쟁하는(lock-free) 대신 동시 실행되는 연산을 도와줌</li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="추가">추가<a href="https://dream2405.github.io/blog/intro-wait-free-algorithms/#%EC%B6%94%EA%B0%80" class="hash-link" aria-label="추가에 대한 직접 링크" title="추가에 대한 직접 링크">​</a></h2>
<p>오타나 잘못된 정보가 일부 있을 수 있습니다. 정정 사항이 있으면 댓글로 남겨주시면 감사하겠습니다.</p>]]></content>
        <author>
            <name>dream2405</name>
        </author>
        <category label="C++" term="C++"/>
        <category label="동시성 프로그래밍" term="동시성 프로그래밍"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Monads and more]]></title>
        <id>https://dream2405.github.io/blog/monads-and-more/</id>
        <link href="https://dream2405.github.io/blog/monads-and-more/"/>
        <updated>2025-09-01T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[banner]]></summary>
        <content type="html"><![CDATA[<p><img decoding="async" loading="lazy" alt="banner" src="https://dream2405.github.io/blog/assets/images/image-00cc092da462a610f16e1795684384d2.png" width="1198" height="508" class="img_ev3q"></p>
<p>하스켈에서는 parameterised type에 함수를 적용할 수 있는 여러 방법들이 있다.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="functors">Functors<a href="https://dream2405.github.io/blog/monads-and-more/#functors" class="hash-link" aria-label="Functors에 대한 직접 링크" title="Functors에 대한 직접 링크">​</a></h2>
<p>다음과 같은 간단한 함수들을 보자.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token hvariable">inc</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token constant" style="color:#36acaa">Int</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token constant" style="color:#36acaa">Int</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">inc</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">      </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">inc</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token hvariable">n</span><span class="token operator" style="color:#393A34">:</span><span class="token hvariable">ns</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token hvariable">n</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token hvariable">inc</span><span class="token plain"> </span><span class="token hvariable">ns</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">sqr</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token constant" style="color:#36acaa">Int</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token constant" style="color:#36acaa">Int</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">sqr</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">      </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">sqr</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token hvariable">n</span><span class="token operator" style="color:#393A34">:</span><span class="token hvariable">ns</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token hvariable">n</span><span class="token operator" style="color:#393A34">^</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token hvariable">sqr</span><span class="token plain"> </span><span class="token hvariable">ns</span><br></span></code></pre></div></div>
<p>이 두 함수의 차이는 리스트의 각 원소에 적용되는 함수 뿐이다.<br>
<!-- -->이러한 패턴은 라이브러리 함수 <code>map</code>으로 간단히 정의할 수 있다.</p>
<p>우선 라이브러리 함수 <code>map</code>을 살펴보자.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin">map</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token hvariable">a</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">b</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token hvariable">a</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token hvariable">b</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin">map</span><span class="token plain"> </span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">        </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin">map</span><span class="token plain"> </span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token hvariable">x</span><span class="token operator" style="color:#393A34">:</span><span class="token hvariable">xs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">    </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token hvariable">x</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">map</span><span class="token plain"> </span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token hvariable">xs</span><br></span></code></pre></div></div>
<p>위의 두개의 함수는 다음과 같이 간단하게 정의된다.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token hvariable">inc</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">map</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">sqr</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">map</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">^</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>이 예시에서 볼 수 있듯이, <code>map</code>은 리스트에서의 각 원소에 대한 함수를 매핑 한다.<br>
<!-- -->그렇다면, 리스트 뿐만이 아닌 다른 자료구조, 더 나아가 여러 parameterised type들에 대해서도 일반화할 수 있지 않을까?</p>
<p>이러한 매핑 함수를 지원하는 타입의 클래스를 <strong>Functor</strong>라고 한다.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Functor</span><span class="token plain"> </span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">fmap</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token hvariable">a</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">b</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token hvariable">a</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token hvariable">b</span><br></span></code></pre></div></div>
<p>parameterised type <code>f</code>가 <code>Functor</code> 클래스의 인스턴스가 되려면, 명시된 타입의 <code>fmap</code> 함수를 지원해야 한다.<br>
<code>fmap</code>은 <code>a -&gt; b</code> 타입의 함수와, 원소의 타입이 <code>a</code>인 <code>f a</code> 구조를 받아서, 그 함수를 각 원소에 적용한 결과로 원소의 타입이 <code>b</code>가 된 <code>f b</code> 구조를 생성한다.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="예시">예시<a href="https://dream2405.github.io/blog/monads-and-more/#%EC%98%88%EC%8B%9C" class="hash-link" aria-label="예시에 대한 직접 링크" title="예시에 대한 직접 링크">​</a></h3>
<p>리스트 타입은 <code>fmap</code>을 <code>map</code> 함수로 간단히 정의함으로써 펑터로 만들 수 있다.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">instance</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Functor</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">-- fmap :: (a -&gt; b) -&gt; [a] -&gt; [b]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">fmap</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">map</span><br></span></code></pre></div></div>
<p>이 선언에서 <code>[]</code> 기호는 타입 매개변수가 없는 리스트 타입을 나타낸다. 이는 <code>[a]</code> 타입이 리스트 타입 <code>[]</code>을 매개변수 타입 <code>a</code>에 적용한 <code>[] a</code>라는 더 원시적인 형태로도 쓰일 수 있다는 사실에 근거한다.</p>
<p>또한, 위 코드에서 <code>fmap</code>의 타입이 명시적으로 선언되지 않고 주석으로 작성된 점에 주목해야 한다. 이는 하스켈이 인스턴스 선언에 이러한 타입 정보를 허용하지 않기 때문이다. 하지만 <code>fmap</code>의 정의를 드러내고 문서화를 위해, 타입을 주석으로 포함했다.</p>
<p><br>
<!-- -->두 번째 예시로, 실패하거나 성공할 수 있는 <code>a</code> 타입의 값을 나타내는 내장 타입 <code>Maybe a</code>를 떠올려 보자.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">data</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Maybe</span><span class="token plain"> </span><span class="token hvariable">a</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Nothing</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Just</span><span class="token plain"> </span><span class="token hvariable">a</span><br></span></code></pre></div></div>
<p>다음과 같이 적절한 타입의 <code>fmap</code> 함수를 정의하면 간단히 <code>Maybe</code> 타입을 펑터로 만들 수 있다.<br>
<!-- -->(펑터를 나타내는 <code>f</code>와의 혼동을 피하고자 인자로 받는 함수를 <code>g</code>라고 부름)</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">instance</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Functor</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Maybe</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">-- fmap :: (a -&gt; b) -&gt; Maybe a -&gt; Maybe b</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">fmap</span><span class="token plain"> </span><span class="token hvariable">_</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Nothing</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Nothing</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">fmap</span><span class="token plain"> </span><span class="token hvariable">g</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Just</span><span class="token plain"> </span><span class="token hvariable">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Just</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token hvariable">g</span><span class="token plain"> </span><span class="token hvariable">x</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>즉, 실패한 값(<code>Nothing</code>)에 함수를 매핑하면 실패가 그대로 전파되는 결과가 나오고, 성공한 값(<code>Just</code>)의 경우에는 내부 값에 함수를 적용한 후 다시 태그를 붙인다.</p>
<p>사용 예를 들면 다음과 같다.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token builtin">fmap</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Nothing</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">Nothing</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token builtin">fmap</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Just</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">Just</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token builtin">fmap</span><span class="token plain"> </span><span class="token builtin">not</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Just</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">Just</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">True</span><br></span></code></pre></div></div>
<p><br>
<!-- -->사용자 정의 타입 또한 펑터로 만들 수 있다. 예를 들어, leaf에 데이터를 갖는 이진 트리 타입을 선언한다고 가정해 보자.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">data</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Tree</span><span class="token plain"> </span><span class="token hvariable">a</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Leaf</span><span class="token plain"> </span><span class="token hvariable">a</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Node</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Tree</span><span class="token plain"> </span><span class="token hvariable">a</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Tree</span><span class="token plain"> </span><span class="token hvariable">a</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">deriving</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Show</span><br></span></code></pre></div></div>
<p><code>deriving Show</code> 구문은 트리가 화면에 표시될 수 있도록 보장한다. 그 후, 매개변수화된 타입 <code>Tree</code>는 주어진 함수를 트리의 각 잎 값에 적용하는 <code>fmap</code> 함수를 정의함으로써 펑터로 만들 수 있다.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">instance</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Functor</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Tree</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">-- fmap :: (a -&gt; b) -&gt; Tree a -&gt; Tree b</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">fmap</span><span class="token plain"> </span><span class="token hvariable">g</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Leaf</span><span class="token plain"> </span><span class="token hvariable">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Leaf</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token hvariable">g</span><span class="token plain"> </span><span class="token hvariable">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">fmap</span><span class="token plain"> </span><span class="token hvariable">g</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Node</span><span class="token plain"> </span><span class="token hvariable">l</span><span class="token plain"> </span><span class="token hvariable">r</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Node</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">fmap</span><span class="token plain"> </span><span class="token hvariable">g</span><span class="token plain"> </span><span class="token hvariable">l</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">fmap</span><span class="token plain"> </span><span class="token hvariable">g</span><span class="token plain"> </span><span class="token hvariable">r</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>예를 들면 다음과 같다.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token builtin">fmap</span><span class="token plain"> </span><span class="token builtin">length</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Leaf</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"abc"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">Leaf</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token builtin">fmap</span><span class="token plain"> </span><span class="token builtin">even</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Node</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Leaf</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Leaf</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">Node</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Leaf</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Leaf</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>하스켈에서 사용되는 많은 펑터 <code>f</code>는 위 세 예시와 유사하다. 즉, <code>f a</code>가 <code>a</code> 타입의 원소를 포함하는 자료 구조라는 의미에서 때로 <strong>컨테이너 타입(container type)</strong> 이라 불리며, <code>fmap</code>은 주어진 함수를 각 원소에 적용한다.</p>
<p>하지만 모든 인스턴스가 이 패턴에 들어맞는 것은 아니다. 예를 들어, <code>IO</code> 타입은 일반적인 의미의 컨테이너 타입이 아니다. 왜냐하면 그 값은 우리가 내부 구조에 접근할 수 없는 입출력 액션(action)을 나타내기 때문이다. 하지만 이는 쉽게 펑터로 만들 수 있다.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">instance</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Functor</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">IO</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">-- fmap :: (a -&gt; b) -&gt; IO a -&gt; IO b</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">fmap</span><span class="token plain"> </span><span class="token hvariable">g</span><span class="token plain"> </span><span class="token hvariable">mx</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token hvariable">x</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain"> </span><span class="token hvariable">mx</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token builtin">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token hvariable">g</span><span class="token plain"> </span><span class="token hvariable">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>이 경우, <code>fmap</code>은 인자로 주어진 액션의 결과 값에 함수를 적용하며, 이를 통해 그러한 값들을 처리하는 수단을 제공한다. 예를 들면 다음과 같다.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token builtin">fmap</span><span class="token plain"> </span><span class="token builtin">show</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">return</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">"True"</span><br></span></code></pre></div></div>
<p><br>
<!-- -->펑터를 사용하는 핵심적인 이점 두 가지</p>
<ol>
<li><code>fmap</code> 함수는 펑터의 성질을 만족하는(functorial) 어떤 구조의 원소든 처리하는 데 사용됨<br>
<!-- -->즉, 각 인스턴스마다 별개의 함수 이름을 만들어낼 필요 없이, 본질적으로 동일한 역할을 하는 함수들에 대해 같은 이름을 사용할 수 있다.</li>
<li>어떤 펑터에나 사용할 수 있는 일반화된(generic) 함수를 정의<br>
<!-- -->예를 들어, 리스트의 각 정수를 1씩 증가시키던 이전의 함수는 <code>map</code> 대신 <code>fmap</code>을 사용하기만 하면 어떤 펑터 타입에도 적용되도록 일반화할 수 있다.</li>
</ol>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token hvariable">inc</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Functor</span><span class="token plain"> </span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Int</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">inc</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">fmap</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>예를 들면 다음과 같다</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token hvariable">inc</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Just</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">Just</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token hvariable">inc</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token hvariable">inc</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Node</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Leaf</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Leaf</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">Node</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Leaf</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Leaf</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="functor-laws">Functor laws<a href="https://dream2405.github.io/blog/monads-and-more/#functor-laws" class="hash-link" aria-label="Functor laws에 대한 직접 링크" title="Functor laws에 대한 직접 링크">​</a></h3>
<p>명시된 타입의 <code>fmap</code> 함수를 제공하는 것 외에도, 펑터는 두 가지 등식 법칙을 만족해야 한다.</p>
<ul>
<li><code>fmap id</code> = <code>id</code></li>
<li><code>fmap (g . h)</code> = <code>fmap g . fmap h</code></li>
</ul>
<p>첫 번째 등식은 <code>fmap</code>이 <strong>항등 함수(identity function)를 보존</strong>한다는 것을 의미한다.<br>
<!-- -->즉, <code>fmap</code>을 항등 함수에 적용하면 결과로 같은 항등 함수를 반환한다. 하지만 이 등식에서 <code>id</code>는 두 번 나타나지만 서로 타입이 다르다는 점에 유의해야 한다. 좌변의 <code>id</code>는 <code>a -&gt; a</code> 타입을 가지므로 <code>fmap id</code>의 타입은 <code>f a -&gt; f a</code>가 된다. 따라서 등식이 성립하려면 우변의 <code>id</code> 또한 <code>f a -&gt; f a</code> 타입을 가져야만 한다.</p>
<p>두 번째 등식은 <code>fmap</code>이 <strong>함수 합성을 보존</strong>한다는 것을 의미한다.<br>
<!-- -->즉, 두 함수의 합성에 <code>fmap</code>을 적용하는 것은, 두 함수 각각에 <code>fmap</code>을 적용한 뒤 그 결과를 합성하는 것과 결과가 같다. 이 합성이 타입 검사를 통과하려면, 구성 요소인 함수 <code>g</code>와 <code>h</code>는 각각 <code>b -&gt; c</code>와 <code>a -&gt; b</code> 타입을 가져야 한다.</p>
<p><code>fmap</code>의 다형적 타입과 결합된 이 펑터 법칙들은 <code>fmap</code>이 실제로 매핑(mapping) 연산을 수행하도록 보장한다. 예를 들어, 리스트의 경우 이 법칙들은 원소가 추가되거나, 제거되거나, 재배열되지 않고 인자로 주어진 리스트의 구조가 보존됨을 보장한다.</p>
<p>만약 내장 리스트 펑터를 리스트 원소의 순서를 뒤집는 <code>fmap</code>의 대체 버전으로 교체했다고 가정해 보자.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">instance</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Functor</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">-- fmap :: (a -&gt; b) -&gt; f a -&gt; f b</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">fmap</span><span class="token plain"> </span><span class="token hvariable">g</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">     </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">fmap</span><span class="token plain"> </span><span class="token hvariable">g</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token hvariable">x</span><span class="token operator" style="color:#393A34">:</span><span class="token hvariable">xs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">fmap</span><span class="token plain"> </span><span class="token hvariable">g</span><span class="token plain"> </span><span class="token hvariable">xs</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">++</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token hvariable">g</span><span class="token plain"> </span><span class="token hvariable">x</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre></div></div>
<p>(만약 이 예제를 GHCi에서 실행해보고 싶다면, 내장 리스트 펑터와의 충돌을 피하기 위해 위 선언을 수정하여 자신만의 리스트 타입을 먼저 선언해야 한다.) 이 선언은 타입은 올바르지만, 다음 예제에서 보듯이 펑터 법칙을 만족하지 못한다.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token builtin">fmap</span><span class="token plain"> </span><span class="token builtin">id</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token builtin">id</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token builtin">fmap</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">not</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">.</span><span class="token plain"> </span><span class="token builtin">even</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token constant" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">,</span><span class="token constant" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">fmap</span><span class="token plain"> </span><span class="token builtin">not</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">.</span><span class="token plain"> </span><span class="token builtin">fmap</span><span class="token plain"> </span><span class="token builtin">even</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token constant" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token constant" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre></div></div>
<p>우리가 예제 섹션에서 정의했던 모든 펑터들은 펑터 법칙을 만족한다. 사실, 하스켈의 어떤 매개변수화된 타입에 대해, 필요한 법칙들을 만족하는 <code>fmap</code> 함수는 기껏해야 하나뿐이다. 즉, 주어진 매개변수화된 타입을 펑터로 만들 수 있는 방법이 있다면, 그 방법은 단 하나뿐이라는 것이다. 따라서 우리가 정의했던 리스트, <code>Maybe</code>, <code>Tree</code>, <code>IO</code>에 대한 인스턴스들은 모두 유일하게 결정된 것이다.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="applicatives">Applicatives<a href="https://dream2405.github.io/blog/monads-and-more/#applicatives" class="hash-link" aria-label="Applicatives에 대한 직접 링크" title="Applicatives에 대한 직접 링크">​</a></h2>
<p>펑터는 구조의 각 원소 위로 함수를 매핑한다는 아이디어를 추상화한다. 이제 이 아이디어를 일반화하여, 단일 인자를 갖는 함수에 제약되는 대신 임의의 개수의 인자를 갖는 함수를 매핑할 수 있도록 하고 싶다고 가정해 보자. 더 정확히는, 다음과 같은 타입을 갖는 <code>fmap</code> 함수들의 계층을 정의하고 싶다고 가정해 보자.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token hvariable">fmap0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token plain"> </span><span class="token hvariable">a</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token hvariable">a</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">fmap1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token hvariable">a</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">b</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token hvariable">a</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token hvariable">b</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">fmap2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token hvariable">a</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">b</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">c</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token hvariable">a</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token hvariable">b</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token hvariable">c</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">fmap3</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token hvariable">a</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">b</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">c</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">d</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token hvariable">a</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token hvariable">b</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token hvariable">c</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token hvariable">d</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre></div></div>
<p><code>fmap1</code>은 <code>fmap</code>의 다른 이름일 뿐이고, <code>fmap0</code>는 매핑되는 함수가 인자를 갖지 않는 퇴화된(degenerate) 경우이다. 한 가지 가능한 접근법은 각 경우에 대해 펑터 클래스의 특별한 버전(Functor0, Functor1, Functor2 등)을 선언하는 것이다. 그러면 예를 들어 다음과 같이 쓸 수 있다.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token hvariable">fmap2</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">+</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Just</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Just</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">Just</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><br></span></code></pre></div></div>
<p>하지만 이 방법은 여러 면에서 만족스럽지 않다.</p>
<ul>
<li>모든 펑터 클래스들이 유사한 패턴을 따름에도 불구하고 각 버전을 수동으로 선언해야 한다.</li>
<li>무한히 많은 클래스가 있지만 우리는 유한한 수만 선언할 수 있으므로, 얼마나 많은 클래스를 선언해야 할지 명확하지 않다.</li>
</ul>
<p><code>(a -&gt; b) -&gt; f a -&gt; f b</code> 타입의 <code>fmap</code>을 <code>(a -&gt; b) -&gt; a -&gt; b</code> 타입의 내장 함수 적용 연산자를 일반화한 것으로 간주한다면, 원하는 동작을 달성하기 위해 일종의 <strong>커링(currying)</strong> 을 사용할 수 있을 것이라 기대할 수 있다. 특히, 우리는 <code>add x y = x + y</code>와 같은 정의에서 커링에 의존할 뿐, 인자 개수가 다른 함수들을 위해 특별한 버전의 적용(application)을 필요로 하지 않는다.</p>
<p><br>
<!-- -->커링(currying)의 아이디어를 사용하면, 임의의 인자 개수를 갖는 함수를 위한 <code>fmap</code>의 버전은 다음 두 가지 기본 함수의 타입으로 구성될 수 있다.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token hvariable">pure</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token plain"> </span><span class="token hvariable">a</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token hvariable">a</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&lt;*&gt;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token plain"> </span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token hvariable">a</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">b</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token hvariable">a</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token hvariable">b</span><br></span></code></pre></div></div>
<p>즉, <code>pure</code>는 <code>a</code> 타입의 값을 <code>f a</code> 타입의 구조로 변환하는 반면, <code>&lt;*&gt;</code>는 인자로 주어지는 함수, 인자 값, 그리고 결과 값이 모두 <code>f</code> 구조 안에 포함되는, 일반화된 형태의 함수 적용이다. 일반적인 함수 적용과 마찬가지로 <code>&lt;*&gt;</code> 연산자는 두 인자 사이에 중위(infix) 표기법으로 사용되며 왼쪽 결합(left-associative)을 한다고 가정한다.<br>
<!-- -->예를 들어, <code>g &lt;*&gt; x &lt;*&gt; y &lt;*&gt; z</code>는 다음과 같이 해석된다.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token hvariable">g</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;*&gt;</span><span class="token plain"> </span><span class="token hvariable">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;*&gt;</span><span class="token plain"> </span><span class="token hvariable">y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;*&gt;</span><span class="token plain"> </span><span class="token hvariable">z</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p><code>pure</code>와 <code>&lt;*&gt;</code>의 전형적인 사용 형태는 다음과 같다.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token hvariable">pure</span><span class="token plain"> </span><span class="token hvariable">g</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;*&gt;</span><span class="token plain"> </span><span class="token hvariable">x1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;*&gt;</span><span class="token plain"> </span><span class="token hvariable">x2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;*&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;*&gt;</span><span class="token plain"> </span><span class="token hvariable">xn</span><br></span></code></pre></div></div>
<p>이러한 표현식은 <strong>어플리커티브 스타일(applicative style)</strong> 이라고 한다. 이는 일반적인 함수 적용 표기법인 <code>g x1 x2 ... xn</code>과의 유사성 때문이다. 두 경우 모두, <code>g</code>는 <code>a1 ... an</code> 타입의 인자 n개를 받아 <code>b</code> 타입의 결과를 생성하는 커링된 함수이다. 하지만 어플리커티브 스타일에서는 각 인자 <code>xi</code>가 <code>ai</code>가 아닌 <code>f ai</code> 타입을 가지며, 전체 결과 또한 <code>b</code>가 아닌 <code>f b</code> 타입을 갖는다. 이 아이디어를 사용하여 매핑 함수의 계층을 다음과 같이 정의할 수 있다.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token hvariable">fmap0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token plain"> </span><span class="token hvariable">a</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token hvariable">a</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">fmap0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token hvariable">pure</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">fmap1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token hvariable">a</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">b</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token hvariable">a</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token hvariable">b</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">fmap1</span><span class="token plain"> </span><span class="token hvariable">g</span><span class="token plain"> </span><span class="token hvariable">x</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token hvariable">pure</span><span class="token plain"> </span><span class="token hvariable">g</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;*&gt;</span><span class="token plain"> </span><span class="token hvariable">x</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">fmap2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token hvariable">a</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">b</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">c</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token hvariable">a</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token hvariable">b</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token hvariable">c</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">fmap2</span><span class="token plain"> </span><span class="token hvariable">g</span><span class="token plain"> </span><span class="token hvariable">x</span><span class="token plain"> </span><span class="token hvariable">y</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token hvariable">pure</span><span class="token plain"> </span><span class="token hvariable">g</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;*&gt;</span><span class="token plain"> </span><span class="token hvariable">x</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;*&gt;</span><span class="token plain"> </span><span class="token hvariable">y</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">fmap3</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token hvariable">a</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">b</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">c</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">d</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token hvariable">a</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token hvariable">b</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token hvariable">c</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token hvariable">d</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">fmap3</span><span class="token plain"> </span><span class="token hvariable">g</span><span class="token plain"> </span><span class="token hvariable">x</span><span class="token plain"> </span><span class="token hvariable">y</span><span class="token plain"> </span><span class="token hvariable">z</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token hvariable">pure</span><span class="token plain"> </span><span class="token hvariable">g</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;*&gt;</span><span class="token plain"> </span><span class="token hvariable">x</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;*&gt;</span><span class="token plain"> </span><span class="token hvariable">y</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;*&gt;</span><span class="token plain"> </span><span class="token hvariable">z</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre></div></div>
<p>이 정의들의 타입을 직접 확인해보는 것은 좋은 연습이 된다. 하지만 실제로는 다음 섹션에서 보게 될 것처럼 필요에 따라 구성될 수 있으므로 이러한 매핑 함수들을 명시적으로 정의할 필요는 거의 없다.</p>
<p><code>pure</code>와 <code>&lt;*&gt;</code> 개념을 지원하는 펑터를 어플리커티브 펑터(applicative functors), 줄여서 <strong>어플리커티브(applicatives)</strong> 라고 부른다. 하스켈에서 이 개념은 다음과 같은 내장 클래스 선언으로 구현된다.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Functor</span><span class="token plain"> </span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Applicative</span><span class="token plain"> </span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token hvariable">pure</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">::</span><span class="token plain"> </span><span class="token hvariable">a</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token hvariable">a</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&lt;*&gt;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token plain"> </span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token hvariable">a</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">b</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token hvariable">a</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token hvariable">b</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="예시-1">예시<a href="https://dream2405.github.io/blog/monads-and-more/#%EC%98%88%EC%8B%9C-1" class="hash-link" aria-label="예시에 대한 직접 링크" title="예시에 대한 직접 링크">​</a></h3>
<p><code>Maybe</code>가 <code>fmap</code>을 지원하는 펑터라는 사실을 이용하면, 이 타입을 어플리커티브 펑터로 만드는 것은 간단하다.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">instance</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Applicative</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Maybe</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">-- pure :: a -&gt; Maybe a</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token hvariable">pure</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Just</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">-- (&lt;*&gt;) :: Maybe (a -&gt; b) -&gt; Maybe a -&gt; Maybe b</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token constant" style="color:#36acaa">Nothing</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;*&gt;</span><span class="token plain"> </span><span class="token hvariable">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Nothing</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Just</span><span class="token plain"> </span><span class="token hvariable">g</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;*&gt;</span><span class="token plain"> </span><span class="token hvariable">mx</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">fmap</span><span class="token plain"> </span><span class="token hvariable">g</span><span class="token plain"> </span><span class="token hvariable">mx</span><br></span></code></pre></div></div>
<p>즉, <code>pure</code> 함수는 값을 성공적인 결과(<code>Just</code>)로 변환하는 반면, <code>&lt;*&gt;</code> 연산자는 실패할 수도 있는 인자에 실패할 수도 있는 함수를 적용하여 결과를 생성한다.</p>
<p>예를 들면 다음과 같다.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token hvariable">pure</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;*&gt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Just</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">Just</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token hvariable">pure</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">+</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;*&gt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Just</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;*&gt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Just</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">Just</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token hvariable">pure</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">+</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;*&gt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Nothing</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;*&gt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Just</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">Nothing</span><br></span></code></pre></div></div>
<p>이러한 방식으로, <code>Maybe</code>의 어플리커티브 스타일은 실패 전파를 어플리커티브의 자동화된 메커니즘이 처리해주므로, 우리가 직접 실패 가능성이 있는 인자에 순수 함수를 적용하는 것을 관리할 필요가 없는 형태의 예외 처리 프로그래밍을 지원한다.</p>
<p><br>
<!-- -->이제 리스트 타입으로 넘어가 보자. 표준적인 인스턴스 선언은 다음과 같다.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">instance</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Applicative</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">-- pure :: a -&gt; [a]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token hvariable">pure</span><span class="token plain"> </span><span class="token hvariable">x</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token hvariable">x</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">-- (&lt;*&gt;) :: [a -&gt; b] -&gt; [a] -&gt; [b]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token hvariable">gs</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;*&gt;</span><span class="token plain"> </span><span class="token hvariable">xs</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token hvariable">g</span><span class="token plain"> </span><span class="token hvariable">x</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token hvariable">g</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain"> </span><span class="token hvariable">gs</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token hvariable">x</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain"> </span><span class="token hvariable">xs</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre></div></div>
<p>즉, <code>pure</code>는 값을 원소가 하나인 리스트(singleton list)로 변환하고, <code>&lt;*&gt;</code>는 함수들의 리스트와 인자들의 리스트를 받아, 각 함수를 각 인자에 적용하여 모든 결과를 리스트로 반환한다. 예를 들면 다음과 같다.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token hvariable">pure</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;*&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token hvariable">pure</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">+</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;*&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;*&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token hvariable">pure</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;*&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;*&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre></div></div>
<p>이 예제들을 어떻게 이해해야 할까? 핵심은 <code>[a]</code> 타입을 성공 시 여러 결과를 허용하는 <code>Maybe a</code>의 일반화로 보는 것이다. 더 정확히는, 빈 리스트는 실패를 나타내고, 비어있지 않은 리스트는 결과가 성공할 수 있는 모든 가능한 방식을 나타낸다고 생각할 수 있다. 따라서 마지막 예제에서 첫 번째 인자는 두 개의 가능한 값(<code>1</code> 또는 <code>2</code>)을 갖고, 두 번째 인자도 두 개의 가능한 값(<code>3</code> 또는 <code>4</code>)을 가지므로, 곱셈의 결과로 네 개의 가능한 결과(<code>3, 4, 6, 8</code>)가 나오는 것이다.</p>
<p>더 일반적으로, 리스트 컴프리헨션(list comprehension)을 사용하여 두 정수 리스트를 곱하는 모든 가능한 방법을 반환하는 함수를 생각해보자.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token hvariable">prods</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token constant" style="color:#36acaa">Int</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token constant" style="color:#36acaa">Int</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token constant" style="color:#36acaa">Int</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">prods</span><span class="token plain"> </span><span class="token hvariable">xs</span><span class="token plain"> </span><span class="token hvariable">ys</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token hvariable">x</span><span class="token operator" style="color:#393A34">*</span><span class="token hvariable">y</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token hvariable">x</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain"> </span><span class="token hvariable">xs</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token hvariable">y</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain"> </span><span class="token hvariable">ys</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre></div></div>
<p>리스트가 어플리커티브라는 사실을 이용하면, 중간 결과에 이름을 붙일 필요 없이 어플리커티브 정의를 내놓을 수 있다.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token hvariable">prods</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token constant" style="color:#36acaa">Int</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token constant" style="color:#36acaa">Int</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token constant" style="color:#36acaa">Int</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">prods</span><span class="token plain"> </span><span class="token hvariable">xs</span><span class="token plain"> </span><span class="token hvariable">ys</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token hvariable">pure</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;*&gt;</span><span class="token plain"> </span><span class="token hvariable">xs</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;*&gt;</span><span class="token plain"> </span><span class="token hvariable">ys</span><br></span></code></pre></div></div>
<p>요약하자면, 리스트의 어플리커티브 스타일은 일종의 <strong>비결정적 프로그래밍(non-deterministic programming)</strong> 을 지원한다. 이를 통해 값의 선택이나 실패 전파를 직접 관리할 필요 없이, 순수 함수를 다중-값 인자에 적용할 수 있으며, 이는 어플리커티브의 자동화된 메커니즘이 처리해준다.</p>
<p>이 섹션에서 다룰 마지막 타입은 <code>IO</code> 타입이며, 다음 선언을 사용하여 어플리커티브 펑터로 만들 수 있다.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">instance</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Applicative</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">IO</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">-- pure :: a -&gt; IO a</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token hvariable">pure</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">return</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">-- (&lt;*&gt;) :: IO (a -&gt; b) -&gt; IO a -&gt; IO b</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token hvariable">mg</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;*&gt;</span><span class="token plain"> </span><span class="token hvariable">mx</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token hvariable">g</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain"> </span><span class="token hvariable">mg</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token hvariable">x</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain"> </span><span class="token hvariable">mx</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token builtin">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token hvariable">g</span><span class="token plain"> </span><span class="token hvariable">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>이 경우 <code>pure</code>는 <code>IO</code> 타입을 위한 <code>return</code> 함수로 정의되고, <code>&lt;*&gt;</code>는 순수하지 않은(impure) 인자에 순수 함수를 적용하여 순수하지 않은 결과를 내놓는다. 예를 들어, 키보드로부터 주어진 개수의 문자를 읽는 함수는 어플리커티브 스타일로 다음과 같이 정의될 수 있다.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token hvariable">getChars</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Int</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">IO</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">String</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">getChars</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">getChars</span><span class="token plain"> </span><span class="token hvariable">n</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token hvariable">pure</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;*&gt;</span><span class="token plain"> </span><span class="token builtin">getChar</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;*&gt;</span><span class="token plain"> </span><span class="token hvariable">getChars</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token hvariable">n</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>즉, 기본 케이스(base case)에서는 단순히 빈 리스트를 반환하고, 재귀 케이스에서는 첫 번째 문자를 읽은 결과와 나머지 문자 리스트에 리스트 생성자 (<code>:</code>)를 적용한다. 후자의 경우, 만약 이 함수가 <code>do</code> 표기법으로 정의되었다면 필요했을 cons 함수에 공급되는 인자들의 이름을 붙일 필요가 없다.</p>
<p>더 일반적으로, <code>IO</code>의 어플리커티브 스타일은 일종의 <strong>interactive programming</strong> 을 지원한다. 이를 통해 액션의 순서나 결과 값 추출을 직접 관리할 필요 없이, 순수 함수를 순수하지 않은 인자에 적용할 수 있으며, 이는 어플리커티브의 자동화된 메커니즘이 자동으로 처리해준다.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="effectful-programming">Effectful programming<a href="https://dream2405.github.io/blog/monads-and-more/#effectful-programming" class="hash-link" aria-label="Effectful programming에 대한 직접 링크" title="Effectful programming에 대한 직접 링크">​</a></h3>
<p>어플리커티브에 대한 원래 동기는 다중 인자 함수에 대한 매핑 아이디어를 일반화하려는 것이었다. 이는 어플리커티브의 개념에 대한 한가지 유효한 해석이지만, 앞서 살펴본 세 가지 인스턴스(<code>Maybe</code>, <code>List</code>, <code>IO</code>)를 통해 더 추상적인 또 다른 관점이 있다는 것이 분명해진다.</p>
<p>이 인스턴스들 사이의 공통된 주제는 모두 <strong>effects</strong> 를 사용한 프로그래밍과 관련이 있다는 점이다. 각 경우에, 어플리커티브 메커니즘은 친숙한 어플리커티브 스타일로 프로그램을 작성하게 해주는 <code>&lt;*&gt;</code> 연산자를 제공한다. 이 스타일에서는 함수가 인자에 적용되는데, 한 가지 핵심적인 차이점이 있다. 인자들은 더 이상 단순한 값이 아니라, 실패 가능성, 여러 성공 경로, 또는 입출력 액션 수행과 같은 effect를 가질 수 있다.</p>
<p>이러한 방식으로, 어플리커티브 펑터는 순수 함수를 <strong>effectful arguments</strong>에 적용하는 아이디어를 추상화한 것으로도 볼 수 있으며, 허용되는 효과의 정확한 형태는 기반이 되는 펑터의 성질에 따라 달라진다.</p>
<p>effectful programming의 한 형태에 대한 통일된 접근법을 제공하는 것 외에도, 어플리커티브를 사용하는 것은 어떤 어플리커티브 펑터와도 함께 사용할 수 있는 일반화된 함수를 정의할 수 있다는 중요한 이점도 있다.</p>
<p>한 예로, 표준 라이브러리는 다음 함수를 제공한다.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token hvariable">sequenceA</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Applicative</span><span class="token plain"> </span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token hvariable">a</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token hvariable">a</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">sequenceA</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token hvariable">pure</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">sequenceA</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token hvariable">x</span><span class="token operator" style="color:#393A34">:</span><span class="token hvariable">xs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token hvariable">pure</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;*&gt;</span><span class="token plain"> </span><span class="token hvariable">x</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;*&gt;</span><span class="token plain"> </span><span class="token hvariable">sequenceA</span><span class="token plain"> </span><span class="token hvariable">xs</span><br></span></code></pre></div></div>
<p>이 함수는 어플리커티브 액션들의 리스트를, 결과 값들의 리스트를 반환하는 단일 액션으로 변환하며, 어플리커티브 프로그래밍의 공통된 패턴을 포착한다. 예를 들어, <code>getChars</code> 함수는 이제 기본 액션인 <code>getChar</code>를 필요한 횟수만큼 복제하고 그 결과 시퀀스를 실행하는 더 간단한 방식으로 정의될 수 있다.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token hvariable">getChars</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Int</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">IO</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">String</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">getChars</span><span class="token plain"> </span><span class="token hvariable">n</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token hvariable">sequenceA</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">replicate</span><span class="token plain"> </span><span class="token hvariable">n</span><span class="token plain"> </span><span class="token builtin">getChar</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="applicative-laws">Applicative laws<a href="https://dream2405.github.io/blog/monads-and-more/#applicative-laws" class="hash-link" aria-label="Applicative laws에 대한 직접 링크" title="Applicative laws에 대한 직접 링크">​</a></h3>
<p><code>pure</code>와 <code>&lt;*&gt;</code> 함수를 제공하는 것 외에도, 어플리커티브 펑터는 네 가지 등식 법칙을 만족해야 한다.</p>
<ul>
<li><code>pure id &lt;*&gt; x</code> = <code>x</code>
<ul>
<li><strong>항등(Identity)</strong> : <code>pure</code>가 항등 함수를 보존한다는 것을 말한다. 즉, <code>pure id</code>를 적용하는 것은 아무것도 하지 않는 것과 같다.</li>
</ul>
</li>
<li><code>pure (g x)</code> = <code>pure g &lt;*&gt; pure x</code>
<ul>
<li><strong>동형사상(Homomorphism)</strong> : <code>pure</code>가 함수 적용 또한 보존함을 말한다. <code>pure</code>는 일반적인 함수 적용을 어플리커티브 함수 적용으로 분배할 수 있다.</li>
</ul>
</li>
<li><code>x &lt;*&gt; pure y</code> = <code>pure (\g -&gt; g y) &lt;*&gt; x</code>
<ul>
<li><strong>교환(Interchange)</strong> : effectful 함수를 순수한(pure) 인자에 적용할 때, 두 구성 요소의 평가 순서는 중요하지 않다는 것을 말한다.</li>
</ul>
</li>
<li><code>x &lt;*&gt; (y &lt;*&gt; z)</code> = <code>(pure (.) &lt;*&gt; x &lt;*&gt; y) &lt;*&gt; z</code>
<ul>
<li><strong>결합(Composition)</strong> : 관련된 타입들을 제외하면 <code>&lt;*&gt;</code> 연산자가 결합 법칙을 만족한다는 것을 말한다.</li>
</ul>
</li>
</ul>
<p>이 어플리커티브 법칙들은 <code>pure :: a -&gt; f a</code> 함수에 대한 우리의 직관, 즉 <code>a</code> 타입의 값을 <code>f</code> 타입의 세상에 심는다는 개념을 공식화한다. 또한 이 법칙들은 <code>pure</code> 함수와 <code>&lt;*&gt;</code> 연산자를 사용하여 구축된 모든 타입이 올바른 표현식은 어플리커티브 스타일로 다시 작성될 수 있음을 보장한다. 즉, 다음과 같은 형태이다.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pure g &lt;*&gt; x1 &lt;*&gt; x2 &lt;*&gt; ... &lt;*&gt; xn</span><br></span></code></pre></div></div>
<p>우리가 예제에서 정의했던 모든 어플리커티브 펑터는 위 법칙들을 만족한다. 더욱이, 이 인스턴스들은 각각 <code>fmap g x = pure g &lt;*&gt; x</code> 법칙 또한 만족하는데, 이는 <code>fmap</code>이 두 어플리커티브 기본 연산(<code>pure</code>, <code>&lt;*&gt;</code>)으로 어떻게 정의될 수 있는지 보여준다. 사실 이 <code>fmap</code> 관련 법칙은 이전에 언급된 사실, 즉 주어진 매개변수화된 타입을 펑터로 만드는 방법은 단 하나뿐이므로 <code>fmap</code>과 동일해야 하는 함수는 어떤 것이든 실제로 <code>fmap</code>과 같다는 사실 덕분에 공짜로 얻어진다.</p>
<p>마지막으로, 하스켈은 <code>g &lt;$&gt; x = fmap g x</code>로 정의되는 <code>fmap</code>의 중위(infix) 버전인 <code>&lt;$&gt;</code>를 제공한다. 이를 위 <code>fmap</code> 법칙과 결합하면 어플리커티브 스타일의 대안적인 형태를 얻을 수 있다.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">g &lt;$&gt; x1 &lt;*&gt; x2 &lt;*&gt; ... &lt;*&gt; xn</span><br></span></code></pre></div></div>
<p>이 버전이 약간 더 간결하지만, 설명 목적으로는 프로그래밍이 순수 함수를 효과가 있는 인자에 적용하는 것임을 명시적으로 강조하는 <code>pure</code> 버전을 선호한다. 하지만 <code>&lt;$&gt;</code>를 사용하는 버전은 실제 응용 프로그램에서 자주 사용된다.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="monads">Monads<a href="https://dream2405.github.io/blog/monads-and-more/#monads" class="hash-link" aria-label="Monads에 대한 직접 링크" title="Monads에 대한 직접 링크">​</a></h2>
<p>이 장에 나올 마지막 새로운 개념은 effectful programming의 또 다른 패턴을 포착한다. 예시로, 정수 값과 나눗셈 연산자로 구성된 다음 표현식 타입을 생각해보자.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">data</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Expr</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Val</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Int</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Div</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Expr</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Expr</span><br></span></code></pre></div></div>
<p>이러한 표현식은 다음과 같이 평가될 수 있다.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token hvariable">eval</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Expr</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">eval</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Val</span><span class="token plain"> </span><span class="token hvariable">n</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token hvariable">n</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">eval</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Div</span><span class="token plain"> </span><span class="token hvariable">x</span><span class="token plain"> </span><span class="token hvariable">y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token hvariable">eval</span><span class="token plain"> </span><span class="token hvariable">x</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">`div`</span><span class="token plain"> </span><span class="token hvariable">eval</span><span class="token plain"> </span><span class="token hvariable">y</span><br></span></code></pre></div></div>
<p>하지만 이 함수는 0으로 나누는 가능성을 고려하지 않으며, 이 경우 오류를 발생시킨다.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token hvariable">eval</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Div</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Val</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Val</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">***</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Exception</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token hvariable">divide</span><span class="token plain"> </span><span class="token hvariable">by</span><span class="token plain"> </span><span class="token hvariable">zero</span><br></span></code></pre></div></div>
<p>이 문제를 해결하기 위해, 두 번째 인자가 <code>0</code>일 때 <code>Nothing</code>을 반환하는 안전한 버전의 나눗셈 함수를 정의하기 위해 <code>Maybe</code> 타입을 사용할 수 있다.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token hvariable">safediv</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Int</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Int</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Maybe</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">safediv</span><span class="token plain"> </span><span class="token hvariable">_</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Nothing</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">safediv</span><span class="token plain"> </span><span class="token hvariable">n</span><span class="token plain"> </span><span class="token hvariable">m</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Just</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token hvariable">n</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">`div`</span><span class="token plain"> </span><span class="token hvariable">m</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>그리고 <code>eval</code> 함수를 수정하여 두 인자 표현식에 재귀적으로 호출될 때 실패 가능성을 명시적으로 처리하도록 한다.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token hvariable">eval</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Expr</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Maybe</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">eval</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Val</span><span class="token plain"> </span><span class="token hvariable">n</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Just</span><span class="token plain"> </span><span class="token hvariable">n</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">eval</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Div</span><span class="token plain"> </span><span class="token hvariable">x</span><span class="token plain"> </span><span class="token hvariable">y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token hvariable">eval</span><span class="token plain"> </span><span class="token hvariable">x</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">of</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   </span><span class="token constant" style="color:#36acaa">Nothing</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Nothing</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   </span><span class="token constant" style="color:#36acaa">Just</span><span class="token plain"> </span><span class="token hvariable">n</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token hvariable">eval</span><span class="token plain"> </span><span class="token hvariable">y</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">of</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                </span><span class="token constant" style="color:#36acaa">Nothing</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Nothing</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                </span><span class="token constant" style="color:#36acaa">Just</span><span class="token plain"> </span><span class="token hvariable">m</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">safediv</span><span class="token plain"> </span><span class="token hvariable">n</span><span class="token plain"> </span><span class="token hvariable">m</span><br></span></code></pre></div></div>
<p>이제 예를 들면 다음과 같다.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token hvariable">eval</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Div</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Val</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Val</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">Nothing</span><br></span></code></pre></div></div>
<p>이 새로운 정의는 0으로 나누기 이슈를 해결하지만 다소 장황하다. 정의를 단순화하기 위해 <code>Maybe</code>가 어플리커티브라는 사실을 활용하여 <code>eval</code>을 어플리커티브 스타일로 재정의해볼 수 있다.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token hvariable">eval</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Expr</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Maybe</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">eval</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Val</span><span class="token plain"> </span><span class="token hvariable">n</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token hvariable">pure</span><span class="token plain"> </span><span class="token hvariable">n</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">eval</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Div</span><span class="token plain"> </span><span class="token hvariable">x</span><span class="token plain"> </span><span class="token hvariable">y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token hvariable">pure</span><span class="token plain"> </span><span class="token hvariable">safediv</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;*&gt;</span><span class="token plain"> </span><span class="token hvariable">eval</span><span class="token plain"> </span><span class="token hvariable">x</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;*&gt;</span><span class="token plain"> </span><span class="token hvariable">eval</span><span class="token plain"> </span><span class="token hvariable">y</span><br></span></code></pre></div></div>
<p>하지만 이 정의는 타입이 올바르지 않다. 특히, 위 컨텍스트에서는 <code>Int -&gt; Int -&gt; Int</code> 타입의 함수가 필요한데, <code>safediv</code> 함수는 <code>Int -&gt; Int -&gt; Maybe Int</code> 타입을 갖는다. <code>pure safediv</code>를 <code>Maybe (Int -&gt; Int -&gt; Maybe Int)</code> 타입을 갖는 커스텀 정의 함수로 교체해도 도움이 되지 않는데, 이는 두 번째 정수가 0일 때 실패를 나타낼 방법이 없기 때문이다.</p>
<p>결론은 <code>eval</code> 함수가 어플리커티브 펑터가 포착하는 effectful programming의 패턴에 맞지 않는다는 것이다. 어플리커티브 스타일은 순수 함수를 효과가 있는 인자에 적용하도록 제한한다. <code>eval</code>은 이 패턴에 맞지 않는데, <code>safediv</code>를 처리하는 데 사용되는 함수가 순수 함수가 아니라 그 자체로 실패할 수 있기 때문이다.</p>
<p>그렇다면 <code>eval :: Expr -&gt; Maybe Int</code>를 어떻게 더 간단한 방식으로 다시 작성할 수 있을까? 핵심은 <code>eval</code> 정의에 두 번 나타나는 공통 패턴, 즉 <code>Maybe</code> 값에 대한 **경우 분석(case analysis)**을 수행하여 <code>Nothing</code>은 <code>Nothing</code>으로, <code>Just x</code>는 어떤 결과로 매핑하는 것을 관찰하는 것이다. 이 패턴을 추상화하면 다음과 같이 정의되는 새로운 연산자 <code>&gt;&gt;=</code>를 얻을 수 있다.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&gt;&gt;=</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Maybe</span><span class="token plain"> </span><span class="token hvariable">a</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token hvariable">a</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Maybe</span><span class="token plain"> </span><span class="token hvariable">b</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Maybe</span><span class="token plain"> </span><span class="token hvariable">b</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">mx</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;&gt;=</span><span class="token plain"> </span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token hvariable">mx</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">of</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token constant" style="color:#36acaa">Nothing</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Nothing</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token constant" style="color:#36acaa">Just</span><span class="token plain"> </span><span class="token hvariable">x</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token hvariable">x</span><br></span></code></pre></div></div>
<p>즉, <code>&gt;&gt;=</code>는 실패할 수 있는 <code>a</code> 타입의 인자와, 그 결과가 실패할 수 있는 <code>a</code> 타입의 함수를 받아, 실패할 수 있는 <code>b</code> 타입의 결과를 반환한다. 만약 첫 번째 인자가 실패하면 실패를 전파하고, 그렇지 않으면 두 번째 인자인 함수를 첫 번째 인자의 결과에 적용한다. 이런 식으로 <code>&gt;&gt;=</code>는 <code>Maybe</code> 값의 연속과 그 결과 처리를 통합한다. <code>&gt;&gt;=</code> 연산자는 종종 <strong>바인드(bind)</strong> 라고 불린다. 두 번째 인자를 첫 번째 인자의 결과에 바인딩하기 때문이다.</p>
<p>바인드 연산자와 람다 표기법을 사용하여, 이제 <code>eval</code> 함수를 더 간결한 방식으로 재정의할 수 있다.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token hvariable">eval</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Expr</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Maybe</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">eval</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Val</span><span class="token plain"> </span><span class="token hvariable">n</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Just</span><span class="token plain"> </span><span class="token hvariable">n</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">eval</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Div</span><span class="token plain"> </span><span class="token hvariable">x</span><span class="token plain"> </span><span class="token hvariable">y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token hvariable">eval</span><span class="token plain"> </span><span class="token hvariable">x</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;&gt;=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">\</span><span class="token hvariable">n</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 </span><span class="token hvariable">eval</span><span class="token plain"> </span><span class="token hvariable">y</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;&gt;=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">\</span><span class="token hvariable">m</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 </span><span class="token hvariable">safediv</span><span class="token plain"> </span><span class="token hvariable">n</span><span class="token plain"> </span><span class="token hvariable">m</span><br></span></code></pre></div></div>
<p><code>Div</code>의 경우는 먼저 <code>x</code>를 평가하여 그 결과를 <code>n</code>이라 하고, 그 다음 <code>y</code>를 평가하여 그 결과를 <code>m</code>이라 한 뒤, <code>safediv</code>를 사용하여 두 결과를 결합하는 상태를 명시한다.</p>
<p>위 예제로부터 일반화하면, <code>&gt;&gt;=</code> 연산자를 사용하여 구축된 표현식은 전형적으로 다음과 같은 구조를 가진다.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token hvariable">m1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;&gt;=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">\</span><span class="token hvariable">x1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">m2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;&gt;=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">\</span><span class="token hvariable">x2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">mn</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;&gt;=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">\</span><span class="token hvariable">xn</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token hvariable">x1</span><span class="token plain"> </span><span class="token hvariable">x2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"> </span><span class="token hvariable">xn</span><br></span></code></pre></div></div>
<p>즉, 우리는 <code>m1 ... mn</code> 각각의 표현식을 차례로 평가하고, 그 결과 값 <code>x1 ... xn</code>을 함수 <code>f</code>에 적용하여 결합한다. <code>&gt;&gt;=</code> 연산자의 정의는 시퀀스의 모든 구성요소 <code>mi</code>가 성공할 경우에만 이러한 표현식이 성공하도록 보장한다. 더 나아가, <code>&gt;&gt;=</code> 연산자의 정의에 의해 시퀀스의 어느 지점에서든 실패를 처리하는 문제가 자동으로 처리되므로 사용자는 이에 대해 걱정할 필요가 없다.</p>
<p>하스켈은 위와 같은 형태의 표현식을 다음과 같이 더 간단한 방식으로 작성할 수 있도록 특별한 표기법을 제공한다.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">do</span><span class="token plain"> </span><span class="token hvariable">x1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain"> </span><span class="token hvariable">m1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token hvariable">x2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain"> </span><span class="token hvariable">m2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token hvariable">xn</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain"> </span><span class="token hvariable">mn</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token hvariable">x1</span><span class="token plain"> </span><span class="token hvariable">x2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"> </span><span class="token hvariable">xn</span><br></span></code></pre></div></div>
<p>이는 상호작용 프로그래밍(interactive programming)에서도 사용되는 것과 동일한 표기법이다. 여기에서도 시퀀스의 각 항목은 동일한 열에서 시작해야 하며, 결과 값 <code>xi</code>가 필요하지 않은 경우 <code>xi &lt;- mi</code>는 <code>mi</code>로 축약될 수 있다. 이 <code>do</code> 표기법을 사용하면 <code>eval</code>은 이제 다음과 같이 간단하게 재정의될 수 있다.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token hvariable">eval</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Expr</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Maybe</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">eval</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Val</span><span class="token plain"> </span><span class="token hvariable">n</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Just</span><span class="token plain"> </span><span class="token hvariable">n</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">eval</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Div</span><span class="token plain"> </span><span class="token hvariable">x</span><span class="token plain"> </span><span class="token hvariable">y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"> </span><span class="token hvariable">n</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain"> </span><span class="token hvariable">eval</span><span class="token plain"> </span><span class="token hvariable">x</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token hvariable">m</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain"> </span><span class="token hvariable">eval</span><span class="token plain"> </span><span class="token hvariable">y</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token hvariable">safediv</span><span class="token plain"> </span><span class="token hvariable">n</span><span class="token plain"> </span><span class="token hvariable">m</span><br></span></code></pre></div></div>
<p>더 일반적으로, <code>do</code> 표기법은 <code>IO</code>나 <code>Maybe</code> 타입에만 국한되지 않고, <strong>모나드(monad)</strong> 를 형성하는 모든 어플리커티브 타입과 함께 사용될 수 있다. 하스켈에서 모나드의 개념은 다음과 같은 내장 선언으로 구현된다.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Applicative</span><span class="token plain"> </span><span class="token hvariable">m</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Monad</span><span class="token plain"> </span><span class="token hvariable">m</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token plain"> </span><span class="token hvariable">a</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">m</span><span class="token plain"> </span><span class="token hvariable">a</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&gt;&gt;=</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">::</span><span class="token plain"> </span><span class="token hvariable">m</span><span class="token plain"> </span><span class="token hvariable">a</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token hvariable">a</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">m</span><span class="token plain"> </span><span class="token hvariable">b</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">m</span><span class="token plain"> </span><span class="token hvariable">b</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token hvariable">pure</span><br></span></code></pre></div></div>
<p>즉, 모나드는 명시된 타입의 <code>return</code>과 <code>&gt;&gt;=</code> 함수를 지원하는 어플리커티브 타입이다. 기본 정의 <code>return = pure</code>는 <code>return</code>이 일반적으로 어플리커티브 함수 <code>pure</code>의 다른 이름일 뿐이지만, 원한다면 인스턴스 선언에서 오버라이드(override)될 수 있음을 의미한다.</p>
<p><code>return</code> 함수는 역사적인 이유로, 그리고 <code>return</code>과 <code>&gt;&gt;=</code> 함수를 모두 포함한다고 가정하는 기존 코드, 논문, 교과서와의 하위 호환성을 보장하기 위해 <code>Monad</code> 클래스에 포함되어 있다. 하지만 미래의 어느 시점에는 <code>return</code>이 <code>Monad</code> 클래스에서 제거되고 대신 다음과 같은 정의를 갖는 라이브러리 함수가 될 수도 있다.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Applicative</span><span class="token plain"> </span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token hvariable">a</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token hvariable">a</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token hvariable">pure</span><br></span></code></pre></div></div>
<p>만약 이 변경이 구현되면, 더 이상 인스턴스 선언에서 <code>return</code>을 정의하는 것이 불가능해지지만, 우리는 일반적으로 기본 정의인 <code>return = pure</code>를 사용하므로 대부분의 예제는 영향을 받지 않을 것이다.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="예시-2">예시<a href="https://dream2405.github.io/blog/monads-and-more/#%EC%98%88%EC%8B%9C-2" class="hash-link" aria-label="예시에 대한 직접 링크" title="예시에 대한 직접 링크">​</a></h3>
<p>표준 라이브러리(prelude)에서, <code>Maybe</code> 타입의 바인드(bind) 연산자는 단순성을 위해 케이스 분석 대신 패턴 매칭을 사용하여 정의된다.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">instance</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Monad</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Maybe</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">-- (&gt;&gt;=) :: Maybe a -&gt; (a -&gt; Maybe b) -&gt; Maybe b</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token constant" style="color:#36acaa">Nothing</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;&gt;=</span><span class="token plain"> </span><span class="token hvariable">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Nothing</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Just</span><span class="token plain"> </span><span class="token hvariable">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;&gt;=</span><span class="token plain"> </span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token hvariable">x</span><br></span></code></pre></div></div>
<p>이 선언 때문에 <code>do</code> 표기법이 이전 섹션의 <code>eval</code> 함수에서처럼 <code>Maybe</code> 값을 프로그래밍하는 데 사용될 수 있는 것이다.</p>
<p><br>
<!-- -->리스트 또한 다음과 같이 모나드 타입으로 만들어질 수 있다.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">instance</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Monad</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">-- (&gt;&gt;=) :: [a] -&gt; (a -&gt; [b]) -&gt; [b]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token hvariable">xs</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;&gt;=</span><span class="token plain"> </span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token hvariable">y</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token hvariable">x</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain"> </span><span class="token hvariable">xs</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token hvariable">y</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain"> </span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token hvariable">x</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre></div></div>
<p>즉, <code>xs &gt;&gt;= f</code>는 <code>xs</code>의 각 결과 <code>x</code>에 함수 <code>f</code>를 적용하고, 그 결과 값들을 모두 리스트에 모은다. 이런 식으로 리스트의 바인드 연산자는 여러 결과를 생성할 수 있는 표현식을 시퀀싱하는 수단을 제공한다. 예를 들어, 두 리스트의 원소를 짝짓는 모든 가능한 방법을 반환하는 함수는 이제 <code>do</code> 표기법을 사용하여 정의할 수 있다.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token hvariable">pairs</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token hvariable">a</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token hvariable">b</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">(</span><span class="token hvariable">a</span><span class="token punctuation" style="color:#393A34">,</span><span class="token hvariable">b</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">pairs</span><span class="token plain"> </span><span class="token hvariable">xs</span><span class="token plain"> </span><span class="token hvariable">ys</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"> </span><span class="token hvariable">x</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain"> </span><span class="token hvariable">xs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 </span><span class="token hvariable">y</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain"> </span><span class="token hvariable">ys</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 </span><span class="token builtin">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token hvariable">x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token hvariable">y</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>예를 들면 다음과 같다.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token hvariable">pairs</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre></div></div>
<p><code>pairs</code>의 마지막 줄에서 기본 정의인 <code>return = pure</code> 때문에 <code>pure (x,y)</code>를 쓸 수도 있었지만, 모나드 프로그래밍에서는 <code>return</code> 함수를 사용하는 것이 관례라는 점에 유의하자. 또한 이 정의가 리스트 컴프리헨션 표기법을 사용한 정의와 유사하다는 점도 흥미롭다.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token hvariable">pairs</span><span class="token plain"> </span><span class="token hvariable">xs</span><span class="token plain"> </span><span class="token hvariable">ys</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">(</span><span class="token hvariable">x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token hvariable">y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token hvariable">x</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain"> </span><span class="token hvariable">xs</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token hvariable">y</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain"> </span><span class="token hvariable">ys</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre></div></div>
<p>하지만 컴프리헨션 표기법은 리스트 타입에만 특정되지만, <code>do</code> 표기법은 임의의 모나드와 함께 사용될 수 있다.</p>
<p><br>
<!-- -->표준 라이브러리는 또한 <code>IO</code> 타입에 대한 인스턴스도 포함하며, 이는 상호작용 프로그래밍을 위한 <code>do</code> 표기법 사용을 지원한다. 위의 다른 예제들과 달리, 이 경우 <code>return</code>과 <code>&gt;&gt;=</code>의 정의는 하스켈 자체 내에서 정의되기보다는 언어에 내장되어 있다.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">instance</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Monad</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">IO</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">-- return :: a -&gt; IO a</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">return</span><span class="token plain"> </span><span class="token hvariable">x</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">-- (&gt;&gt;=) :: IO a -&gt; (a -&gt; IO b) -&gt; IO b</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token hvariable">mx</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;&gt;=</span><span class="token plain"> </span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">...</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-state-monad">The state monad<a href="https://dream2405.github.io/blog/monads-and-more/#the-state-monad" class="hash-link" aria-label="The state monad에 대한 직접 링크" title="The state monad에 대한 직접 링크">​</a></h3>
<p>이제 시간에 따라 변할 수 있는 어떤 형태의 <strong>상태(state)</strong> 를 조작하는 함수를 작성하는 문제를 생각해 보자. 여기서는 간단하게 상태는 단지 정수 값이라고 가정하지만, 필요에 따라 수정될 수 있다:</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">State</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Int</span><br></span></code></pre></div></div>
<p>이 타입에 대한 가장 기본적인 형태의 함수는 상태 변환자(state transformer), 약자로 ST이다. 이것은 입력 상태를 인자로 받아서 결과로 출력 상태를 만들어내며, 이때 출력 상태는 함수 실행 중에 상태에 가해진 모든 변경 사항을 반영한다:</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">ST</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">State</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">State</span><br></span></code></pre></div></div>
<p>하지만 일반적으로, 상태를 갱신하는 것 외에도 결과 값을 반환하고 싶을 수 있다. 예를 들어, 상태가 카운터를 나타낸다면, 카운터를 증가시키는 함수는 그것의 현재 값을 반환하고 싶을 수도 있다. 이러한 이유로, 상태 변환자의 타입을 일반화하여 결과 값도 반환하도록 하며, 이러한 값의 타입은 ST 타입의 파라미터가 된다:</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">ST</span><span class="token plain"> </span><span class="token hvariable">a</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">State</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token hvariable">a</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">State</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p><br>
<!-- -->이러한 함수는 다음과 같이 그림 형태로 표시될 수 있다. 여기서 <strong>s</strong> 는 입력 상태, <strong>s'</strong> 는 출력 상태, <strong>v</strong> 는 결과 값이다:</p>
<p><img decoding="async" loading="lazy" alt="img1" src="https://dream2405.github.io/blog/assets/images/image-1-4b495646e9cd727b5074590e84fb595c.png" width="711" height="414" class="img_ev3q"></p>
<p>반대로, 상태 변환자는 인자 값을 받고 싶을 수도 있다. 하지만 이를 고려하기 위해 ST 타입을 더 일반화할 필요는 없는데, 왜냐하면 이러한 동작은 이미 <strong>커링(currying)</strong> 을 활용하여 달성할 수 있기 때문이다. 예를 들어, 문자를 받아서 정수를 반환하는 상태 변환자는 <code>Char -&gt; ST Int</code> 타입을 가질 것이며, 이는 아래 그림과 같이 커링된 함수 타입인 <code>Char -&gt; State -&gt; (Int, State)</code>를 축약한 것이다:</p>
<p><img decoding="async" loading="lazy" alt="img2" src="https://dream2405.github.io/blog/assets/images/image-2-6f2a80a8712ad90ce8675ea8b29fc9b6.png" width="766" height="370" class="img_ev3q"></p>
<p>ST가 파라미터화된 타입이라는 점을 감안할 때, 이를 <strong>모나드(monad)</strong> 로 만들어서 상태가 있는(stateful) 프로그램을 작성하는 데 <code>do</code> 표기법을 사용할 수 있도록 시도하는 것은 자연스럽다. 하지만, <code>type</code> 메커니즘을 사용해 선언된 타입은 클래스의 인스턴스가 될 수 없다. 따라서, 먼저 newtype 메커니즘을 사용하여 <code>ST</code> 타입을 재정의하는데, 여기에는 <strong>S</strong> 라고 부르는 <strong>더미 생성자(dummy constructor)</strong> 를 도입해야 한다:</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">newtype</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">ST</span><span class="token plain"> </span><span class="token hvariable">a</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">S</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">State</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token hvariable">a</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">State</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>또한 이 타입을 위해 더미 생성자를 단순히 제거하는 특수 목적의 적용 함수(application function)를 정의하는 것이 편리하다:</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token hvariable">app</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">ST</span><span class="token plain"> </span><span class="token hvariable">a</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">State</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token hvariable">a</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">State</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">app</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">S</span><span class="token plain"> </span><span class="token hvariable">st</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token hvariable">x</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token hvariable">st</span><span class="token plain"> </span><span class="token hvariable">x</span><br></span></code></pre></div></div>
<p>파라미터화된 ST 타입을 모나드로 만들기 위한 첫 단계로서, 이 타입을 간단히 <strong>펑터(functor)</strong> 로 만들 수 있다.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">instance</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Functor</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">ST</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">-- fmap :: (a -&gt; b) -&gt; ST a -&gt; ST b</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">fmap</span><span class="token plain"> </span><span class="token hvariable">g</span><span class="token plain"> </span><span class="token hvariable">st</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">S</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">\</span><span class="token hvariable">s</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token hvariable">x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token hvariable">s'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token hvariable">app</span><span class="token plain"> </span><span class="token hvariable">st</span><span class="token plain"> </span><span class="token hvariable">s</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token hvariable">g</span><span class="token plain"> </span><span class="token hvariable">x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token hvariable">s'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>즉, <code>fmap</code>은 다음 그림에서처럼 상태 변환자의 결과 값에 함수를 적용하게 해준다.</p>
<p><img decoding="async" loading="lazy" alt="img3" src="https://dream2405.github.io/blog/assets/images/image-3-bb2d4b50372b25c23a25dc81bd475db7.png" width="1245" height="322" class="img_ev3q"></p>
<p>위 정의에 사용된 하스켈의 <code>let</code> 메커니즘은 <code>where</code> 메커니즘과 유사하지만, 함수 정의 수준이 아닌 표현식 수준에서 local definition을 할 수 있게 해준다는 점이 다르다.
결과적으로, <code>ST</code> 타입은 <strong>어플리커티브 펑터(applicative functor)</strong> 로 만들어질 수 있다.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">instance</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Applicative</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">ST</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">-- pure :: a -&gt; ST a</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token hvariable">pure</span><span class="token plain"> </span><span class="token hvariable">x</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">S</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">\</span><span class="token hvariable">s</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token hvariable">x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token hvariable">s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">-- (&lt;*&gt;) :: ST (a -&gt; b) -&gt; ST a -&gt; ST b</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token hvariable">stf</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;*&gt;</span><span class="token plain"> </span><span class="token hvariable">stx</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">S</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">\</span><span class="token hvariable">s</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token hvariable">f</span><span class="token punctuation" style="color:#393A34">,</span><span class="token hvariable">s'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">   </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token hvariable">app</span><span class="token plain"> </span><span class="token hvariable">stf</span><span class="token plain"> </span><span class="token hvariable">s</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token hvariable">x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token hvariable">s''</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token hvariable">app</span><span class="token plain"> </span><span class="token hvariable">stx</span><span class="token plain"> </span><span class="token hvariable">s'</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token hvariable">x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token hvariable">s''</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>이 경우, <code>pure</code> 함수는 어떤 값을 상태 변경 없이 그대로 반환하는 상태 변환자로 변환한다.</p>
<p><img decoding="async" loading="lazy" alt="img4" src="https://dream2405.github.io/blog/assets/images/image-4-b23eb98ddf23f9eeb8a8bb8e79d6bc43.png" width="902" height="320" class="img_ev3q"></p>
<p>한편, <code>&lt;*&gt;</code> 연산자는 함수를 반환하는 상태 변환자를 인자를 반환하는 상태 변환자에 적용하여, 그 함수를 인자에 적용한 결과를 반환하는 상태 변환자를 만들어낸다.</p>
<p><img decoding="async" loading="lazy" alt="img5" src="https://dream2405.github.io/blog/assets/images/image-5-a4d4951de85e2ef7d7a88b806cf1ed42.png" width="1355" height="450" class="img_ev3q"></p>
<p>기호 <code>$</code>는 일반적인 함수 적용을 나타내며, <code>f $ x</code> = <code>f x</code>로 정의된다.</p>
<p>마지막으로, <code>ST</code>에 대한 모나드 인스턴스는 다음과 같이 선언된다.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">instance</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Monad</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">ST</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">-- (&gt;&gt;=) :: ST a -&gt; (a -&gt; ST b) -&gt; ST b</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token hvariable">st</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;&gt;=</span><span class="token plain"> </span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">S</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">\</span><span class="token hvariable">s</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token hvariable">x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token hvariable">s'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token hvariable">app</span><span class="token plain"> </span><span class="token hvariable">st</span><span class="token plain"> </span><span class="token hvariable">s</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token hvariable">app</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token hvariable">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token hvariable">s'</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>즉, <code>st &gt;&gt;= f</code>는 상태 변환자 <code>st</code>를 초기 상태 <code>s</code>에 적용한 다음, 그 결과 값 <code>x</code>에 함수 <code>f</code>를 적용하여 새로운 상태 변환자 <code>f x</code>를 얻는다. 그리고 이 <code>f x</code>를 새로운 상태 <code>s'</code>에 적용하여 최종 결과를 얻는다.</p>
<p><img decoding="async" loading="lazy" alt="img6" src="https://dream2405.github.io/blog/assets/images/image-6-a4ab6fdf75c28e8d666755be6132af00.png" width="977" height="339" class="img_ev3q"></p>
<p>이런 방식으로, 상태 모나드의 <strong>바인드(bind) 연산자(&gt;&gt;=)</strong> 는 상태 변환자들의 순차적 실행과 그 결과 값의 처리를 통합한다. <code>&gt;&gt;=</code>의 정의 내에서는 첫 번째 인자의 결과 값 <code>x</code>에 따라 동작이 달라질 수 있는 새로운 상태 변환자 <code>f x</code>를 만들어내는 반면, <code>&lt;*&gt;</code>에서는 인자로 명시적으로 제공된 상태 변환자만 사용하도록 제한된다는 점에 주목해야 한다. 따라서 <code>&gt;&gt;=</code> 연산자를 사용하면 더 큰 유연성을 얻을 수 있다.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="relabelling-trees">Relabelling trees<a href="https://dream2405.github.io/blog/monads-and-more/#relabelling-trees" class="hash-link" aria-label="Relabelling trees에 대한 직접 링크" title="Relabelling trees에 대한 직접 링크">​</a></h3>
<p>stateful programming의 한 예시로서, 트리의 라벨을 다시 붙이는 함수를 개발해 보자.<br>
<!-- -->이를 위해 다음 타입을 사용한다.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">data</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Tree</span><span class="token plain"> </span><span class="token hvariable">a</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Leaf</span><span class="token plain"> </span><span class="token hvariable">a</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Node</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Tree</span><span class="token plain"> </span><span class="token hvariable">a</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Tree</span><span class="token plain"> </span><span class="token hvariable">a</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">deriving</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Show</span><br></span></code></pre></div></div>
<p>예를 들어, 다음과 같이 정의할 수 있다.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token hvariable">tree</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Tree</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Char</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">tree</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Node</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Node</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Leaf</span><span class="token plain"> </span><span class="token char string" style="color:#e3116c">'a'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Leaf</span><span class="token plain"> </span><span class="token char string" style="color:#e3116c">'b'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Leaf</span><span class="token plain"> </span><span class="token char string" style="color:#e3116c">'c'</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>이제 이런 트리 내의 각 리프(leaf)를 고유한, 즉 새로운(fresh) 정수로 재라벨링하는 함수를 정의하는 문제를 생각해 보자. 하스켈과 같은 순수 언어에서는 다음에 사용할 새 정수를 추가 인자로 받고, 그 다음 사용할 정수를 추가 결과로 반환하는 방식으로 이를 구현할 수 있다.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token hvariable">rlabel</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Tree</span><span class="token plain"> </span><span class="token hvariable">a</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Int</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Tree</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Int</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">rlabel</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Leaf</span><span class="token plain"> </span><span class="token hvariable">_</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token hvariable">n</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Leaf</span><span class="token plain"> </span><span class="token hvariable">n</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token hvariable">n</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">rlabel</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Node</span><span class="token plain"> </span><span class="token hvariable">l</span><span class="token plain"> </span><span class="token hvariable">r</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token hvariable">n</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Node</span><span class="token plain"> </span><span class="token hvariable">l'</span><span class="token plain"> </span><span class="token hvariable">r'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token hvariable">n''</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token hvariable">l'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token hvariable">n'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">   </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token hvariable">rlabel</span><span class="token plain"> </span><span class="token hvariable">l</span><span class="token plain"> </span><span class="token hvariable">n</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token hvariable">r'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token hvariable">n''</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token hvariable">rlabel</span><span class="token plain"> </span><span class="token hvariable">r</span><span class="token plain"> </span><span class="token hvariable">n'</span><br></span></code></pre></div></div>
<p>그러면, 이 예시에서는 다음과 같은 결과를 얻는다.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token builtin">fst</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token hvariable">rlabel</span><span class="token plain"> </span><span class="token hvariable">tree</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">Node</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Node</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Leaf</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Leaf</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Leaf</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>하지만 <code>rlabel</code>의 정의는 정수 상태를 계산 과정 전체에 걸쳐 명시적으로 전달해야 할 필요성 때문에 복잡하다. 더 간단한 정의를 얻기 위해, 먼저 <code>Tree a -&gt; Int -&gt; (Tree Int, Int)</code> 타입이 상태 변환자 타입을 사용하여 <code>Tree a -&gt; ST (Tree Int)</code>로 다시 작성될 수 있다는 점에 주목한다. 여기서 상태는 다음에 사용할 새 정수이다. 이러한 다음 정수는 현재 상태를 결과로, 그리고 다음 정수를 새로운 상태로 반환하는 상태 변환자를 정의함으로써 생성할 수 있다.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token hvariable">fresh</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">ST</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">fresh</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">S</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">\</span><span class="token hvariable">n</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token hvariable">n</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token hvariable">n</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p><code>ST</code>가 어플리커티브 펑터라는 사실을 이용하여, 이제 어플리커티브 스타일로 작성된 새로운 버전의 재라벨링 함수를 정의할 수 있다.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token hvariable">alabel</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Tree</span><span class="token plain"> </span><span class="token hvariable">a</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">ST</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Tree</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">alabel</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Leaf</span><span class="token plain"> </span><span class="token hvariable">_</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Leaf</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;$&gt;</span><span class="token plain"> </span><span class="token hvariable">fresh</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">alabel</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Node</span><span class="token plain"> </span><span class="token hvariable">l</span><span class="token plain"> </span><span class="token hvariable">r</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Node</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;$&gt;</span><span class="token plain"> </span><span class="token hvariable">alabel</span><span class="token plain"> </span><span class="token hvariable">l</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;*&gt;</span><span class="token plain"> </span><span class="token hvariable">alabel</span><span class="token plain"> </span><span class="token hvariable">r</span><br></span></code></pre></div></div>
<p>(참고: <code>g &lt;$&gt; x &lt;*&gt; y</code>는 <code>pure g &lt;*&gt; x &lt;*&gt; y</code>와 동일하게 동작한다.)<br>
<!-- -->이 새로운 버전은 이전과 동일한 결과를 준다.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token builtin">fst</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token hvariable">app</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token hvariable">alabel</span><span class="token plain"> </span><span class="token hvariable">tree</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">Node</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Node</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Leaf</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Leaf</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Leaf</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>하지만 그 정의는 훨씬 더 간단하다. 기본 케이스(base case)에서는 이제 <code>Leaf</code> 생성자를 다음 새 정수에 적용하기만 하면 되고, 재귀 케이스에서는 두 서브트리를 라벨링한 결과에 <code>Node</code> 생성자를 적용한다. 특히, 프로그래머는 더 이상 정수 상태를 계산 과정에 일일이 전달하는 지루하고 오류가 발생하기 쉬운 작업에 대해 걱정할 필요가 없다. 이 작업은 어플리커티브 메커니즘에 의해 자동으로 처리되기 때문이다.</p>
<p><code>ST</code>가 모나드이기도 하다는 사실을 이용하여, <code>do</code> 표기법을 사용해 이와 동일한 기능의 모나드 버전 재라벨링 함수를 정의할 수 있다.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token hvariable">mlabel</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Tree</span><span class="token plain"> </span><span class="token hvariable">a</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">ST</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Tree</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">mlabel</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Leaf</span><span class="token plain"> </span><span class="token hvariable">_</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"> </span><span class="token hvariable">n</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain"> </span><span class="token hvariable">fresh</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     </span><span class="token builtin">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Leaf</span><span class="token plain"> </span><span class="token hvariable">n</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">mlabel</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Node</span><span class="token plain"> </span><span class="token hvariable">l</span><span class="token plain"> </span><span class="token hvariable">r</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"> </span><span class="token hvariable">l'</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain"> </span><span class="token hvariable">mlabel</span><span class="token plain"> </span><span class="token hvariable">l</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                       </span><span class="token hvariable">r'</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain"> </span><span class="token hvariable">mlabel</span><span class="token plain"> </span><span class="token hvariable">r</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                       </span><span class="token builtin">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Node</span><span class="token plain"> </span><span class="token hvariable">l'</span><span class="token plain"> </span><span class="token hvariable">r'</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>이 정의는 중간 결과에 이름을 붙여줘야 한다는 점을 제외하면 어플리커티브 버전과 유사하다. <code>rlabel</code>과 같은 비-제네릭(non-generic) 함수가 어플리커티브와 모나드 스타일 모두로 정의될 수 있을 때, 어떤 정의를 선호할지는 대체로 취향의 문제이다.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="generic-functions">Generic functions<a href="https://dream2405.github.io/blog/monads-and-more/#generic-functions" class="hash-link" aria-label="Generic functions에 대한 직접 링크" title="Generic functions에 대한 직접 링크">​</a></h3>
<p>모나드라는 개념을 추상화함으로써 얻는 중요한 이점은 어떤 모나드에든 사용할 수 있는 <strong>제네릭 함수(generic function)</strong> 를 정의할 수 있다는 것이다. <code>Control.Monad</code> 라이브러리에는 다수의 그런 함수들이 제공된다.<br>
<!-- -->예를 들어, 리스트에 대한 <code>map</code> 함수의 모나드 버전은 다음과 같이 정의할 수 있다.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin">mapM</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Monad</span><span class="token plain"> </span><span class="token hvariable">m</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token hvariable">a</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">m</span><span class="token plain"> </span><span class="token hvariable">b</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token hvariable">a</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">m</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token hvariable">b</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin">mapM</span><span class="token plain"> </span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">     </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin">mapM</span><span class="token plain"> </span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token hvariable">x</span><span class="token operator" style="color:#393A34">:</span><span class="token hvariable">xs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"> </span><span class="token hvariable">y</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain"> </span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token hvariable">x</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   </span><span class="token hvariable">ys</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain"> </span><span class="token builtin">mapM</span><span class="token plain"> </span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token hvariable">xs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   </span><span class="token builtin">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token hvariable">y</span><span class="token operator" style="color:#393A34">:</span><span class="token hvariable">ys</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p><code>mapM</code>은 인자로 받는 함수와 함수 자체의 반환 타입이 이제 모나드 타입이라는 점을 제외하면 <code>map</code>과 동일한 타입을 갖는다는 점에 주목하자. 이것이 어떻게 사용될 수 있는지 설명하기 위해, 주어진 문자가 숫자일 경우에만 그 문자를 해당하는 숫자 값으로 변환하는 함수를 생각해 보자.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token hvariable">conv</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Maybe</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">conv</span><span class="token plain"> </span><span class="token hvariable">c</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token builtin">isDigit</span><span class="token plain"> </span><span class="token hvariable">c</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Just</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">digitToInt</span><span class="token plain"> </span><span class="token hvariable">c</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token builtin">otherwise</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Nothing</span><br></span></code></pre></div></div>
<p>(<code>isDigit</code>와 <code>digitToInt</code> 함수는 <code>Data.Char</code>에서 제공된다.) <code>mapM</code>을 <code>conv</code> 함수에 적용하면 숫자 문자열을 해당하는 숫자 값의 리스트로 변환하는 수단을 얻게 된다. 이 변환은 문자열의 모든 문자가 숫자일 경우에만 성공하고, 그렇지 않으면 실패한다.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token builtin">mapM</span><span class="token plain"> </span><span class="token hvariable">conv</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"1234"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">Just</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token builtin">mapM</span><span class="token plain"> </span><span class="token hvariable">conv</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"123a"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">Nothing</span><br></span></code></pre></div></div>
<p>다음으로, 리스트에 대한 <code>filter</code> 함수의 모나드 버전은 <code>mapM</code>과 유사한 방식으로 타입과 정의를 일반화하여 정의된다.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token hvariable">filterM</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Monad</span><span class="token plain"> </span><span class="token hvariable">m</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token hvariable">a</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">m</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Bool</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token hvariable">a</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">m</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token hvariable">a</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">filterM</span><span class="token plain"> </span><span class="token hvariable">p</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">     </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">filterM</span><span class="token plain"> </span><span class="token hvariable">p</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token hvariable">x</span><span class="token operator" style="color:#393A34">:</span><span class="token hvariable">xs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"> </span><span class="token hvariable">b</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain"> </span><span class="token hvariable">p</span><span class="token plain"> </span><span class="token hvariable">x</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      </span><span class="token hvariable">ys</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain"> </span><span class="token hvariable">filterM</span><span class="token plain"> </span><span class="token hvariable">p</span><span class="token plain"> </span><span class="token hvariable">xs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      </span><span class="token builtin">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token hvariable">b</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"> </span><span class="token hvariable">x</span><span class="token operator" style="color:#393A34">:</span><span class="token hvariable">ys</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token hvariable">ys</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>예를 들어, 리스트 모나드의 경우 <code>filterM</code>을 사용하면 리스트의 <strong>멱집합(powerset)</strong> 을 특히 간결하게 계산하는 수단을 얻을 수 있다. 멱집합은 리스트의 각 원소를 포함하거나 제외하는 모든 가능한 경우의 수로 주어진다.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token hvariable">filterM</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">\</span><span class="token hvariable">x</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token constant" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token constant" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre></div></div>
<p>마지막 예로, 리스트에 대한 <code>prelude</code> 함수 <code>concat :: [[a]] -&gt; [a]</code>는 임의의 모나드에 대해 다음과 같이 <code>join</code> 함수로 일반화된다.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token hvariable">join</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Monad</span><span class="token plain"> </span><span class="token hvariable">m</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token hvariable">m</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token hvariable">m</span><span class="token plain"> </span><span class="token hvariable">a</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">m</span><span class="token plain"> </span><span class="token hvariable">a</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">join</span><span class="token plain"> </span><span class="token hvariable">mmx</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"> </span><span class="token hvariable">mx</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain"> </span><span class="token hvariable">mmx</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token hvariable">x</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain"> </span><span class="token hvariable">mx</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token builtin">return</span><span class="token plain"> </span><span class="token hvariable">x</span><br></span></code></pre></div></div>
<p>이 함수는 중첩된 모나드 값을 일반 모나드 값으로 평탄화(flatten)한다. 리스트 모나드에 대해서는 <code>concat</code>과 동일한 방식으로 동작하는 한편, <code>Maybe</code> 모나드에 대해서는 바깥쪽과 안쪽 값 모두 성공(<code>Just</code>)일 경우에만 성공한다.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token hvariable">join</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token hvariable">join</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Just</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Just</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">Just</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token hvariable">join</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Just</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Nothing</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">Nothing</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token hvariable">join</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Nothing</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">Nothing</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="monad-laws">Monad laws<a href="https://dream2405.github.io/blog/monads-and-more/#monad-laws" class="hash-link" aria-label="Monad laws에 대한 직접 링크" title="Monad laws에 대한 직접 링크">​</a></h3>
<p>펑터나 어플리커티브와 비슷한 방식으로, 두 모나드 기본 연산(primitive)은 몇 가지 등식 법칙을 만족해야 한다.</p>
<ul>
<li><code>return x &gt;&gt;= f</code> = <code>f x</code></li>
<li><code>mx &gt;&gt;= return</code> = <code>mx</code></li>
<li><code>(mx &gt;&gt;= f) &gt;&gt;= g</code> = <code>mx &gt;&gt;= (\x -&gt; (f x &gt;&gt;= g))</code></li>
</ul>
<p>첫 두 등식은 <code>return</code>과 <code>&gt;&gt;=</code> 사이의 관계에 대한 것이다.</p>
<p><strong>첫 번째 등식(좌항등원, Left identity)</strong> 은, 어떤 값을 <code>return</code>한 뒤 그 결과를 모나드 함수에 넘기는 것은 단순히 그 함수를 값에 적용하는 것과 같은 결과를 주어야 한다는 것을 나타낸다.</p>
<p><strong>두 번째 등식(우항등원, Right identity)</strong> 은, 모나드 계산의 결과를 <code>return</code> 함수에 넘기는 것은 단순히 그 계산을 수행하는 것과 같은 결과를 주어야 한다는 것을 나타낸다.</p>
<p>종합하면, 이 두 등식은 (<code>&gt;&gt;=</code>의 두 번째 인자가 바인딩 연산을 포함한다는 점을 감안하면) <code>return</code>이 <code>&gt;&gt;=</code> 연산자에 대한 항등원(identity)이라는 것을 말해준다.</p>
<p><strong>세 번째 등식(결합법칙, Associativity)</strong> 은 <code>&gt;&gt;=</code>와 자신 사이의 관계에 대한 것으로, (<code>&gt;&gt;=</code>가 바인딩을 포함한다는 점을 다시 감안하면) <code>&gt;&gt;=</code>가 결합법칙을 만족함을 표현한다. 이 등식의 우변을 단순히 <code>mx &gt;&gt;= (f &gt;&gt;= g)</code>로 쓸 수는 없다는 점에 주목해야 하는데, 이는 타입 검사를 통과하지 못할 것이기 때문이다. 우리가 지금까지 봐온 모든 모나드는 위의 법칙들을 만족한다.</p>]]></content>
        <author>
            <name>dream2405</name>
        </author>
        <category label="Haskell" term="Haskell"/>
        <category label="함수형 프로그래밍" term="함수형 프로그래밍"/>
    </entry>
</feed>